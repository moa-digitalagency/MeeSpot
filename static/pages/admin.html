<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MeetSpot - Admin Dashboard</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#FF4458">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; padding-bottom: 80px; max-width: 768px; margin: 0 auto; }
        h1, h2, h3, h4, h5, h6 { font-family: 'Poppins', sans-serif; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; max-width: 768px; margin: 0 auto; background: white; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 50; }
        .nav-item { transition: all 0.2s; }
        .nav-item.active { color: #FF4458; }
        .nav-item svg { width: 24px; height: 24px; }
    </style>
</head>
<body class="bg-[#FFEAA7]">
    <div id="page-dashboard" class="page-content">
        <div class="px-4 pt-4">
            <h1 class="text-2xl font-bold text-[#2D3436] mb-1">Admin Dashboard</h1>
            <p class="text-sm text-[#2D3436] opacity-75 mb-4">Gestion de la plateforme</p>
        </div>

        <div class="px-4 space-y-3 mb-4">
            <div class="bg-gradient-to-br from-[#FF4458] to-[#e03d4c] rounded-2xl p-5 text-white">
                <div class="text-sm opacity-90 mb-1">Utilisateurs totaux</div>
                <div id="totalUsers" class="text-3xl font-bold">0</div>
            </div>
            <div class="bg-gradient-to-br from-[#6C5CE7] to-[#5a4dd9] rounded-2xl p-5 text-white">
                <div class="text-sm opacity-90 mb-1">Rooms actives</div>
                <div id="totalRooms" class="text-3xl font-bold">0</div>
            </div>
            <div class="bg-gradient-to-br from-[#00B894] to-[#00a183] rounded-2xl p-5 text-white">
                <div class="text-sm opacity-90 mb-1">Ã‰tablissements</div>
                <div id="totalEstablishments" class="text-3xl font-bold">0</div>
            </div>
            <div class="bg-gradient-to-br from-[#A29BFE] to-[#9189f7] rounded-2xl p-5 text-white">
                <div class="text-sm opacity-90 mb-1">Signalements en attente</div>
                <div id="totalReports" class="text-3xl font-bold">0</div>
            </div>
        </div>
    </div>

    <div id="page-users" class="page-content hidden">
        <div class="px-4 pt-4 pb-4">
            <h1 class="text-2xl font-bold text-[#2D3436] mb-4">Utilisateurs</h1>
            <div id="usersList" class="space-y-3">
                <p class="text-[#2D3436] opacity-75">Chargement...</p>
            </div>
        </div>
    </div>

    <div id="page-reports" class="page-content hidden">
        <div class="px-4 pt-4 pb-4">
            <h1 class="text-2xl font-bold text-[#2D3436] mb-4">Signalements</h1>
            <div id="reportsList" class="space-y-3">
                <p class="text-[#2D3436] opacity-75">Chargement...</p>
            </div>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="grid grid-cols-3 h-16">
            <button onclick="switchPage('dashboard')" id="nav-dashboard" class="nav-item active flex flex-col items-center justify-center">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                </svg>
                <span class="text-xs mt-1">Dashboard</span>
            </button>
            <button onclick="switchPage('users')" id="nav-users" class="nav-item flex flex-col items-center justify-center">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                </svg>
                <span class="text-xs mt-1">Utilisateurs</span>
            </button>
            <button onclick="switchPage('reports')" id="nav-reports" class="nav-item flex flex-col items-center justify-center">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
                <span class="text-xs mt-1">Signalements</span>
            </button>
        </div>
    </div>

    <script>
        let currentPage = 'dashboard';

        function checkAuth() {
            const token = localStorage.getItem('token');
            const userData = localStorage.getItem('user');
            if (!token || !userData) {
                window.location.href = '/';
                return;
            }
            const user = JSON.parse(userData);
            if (user.role !== 'admin') {
                window.location.href = '/app.html';
            }
        }

        function switchPage(page) {
            currentPage = page;
            
            document.querySelectorAll('.page-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`page-${page}`).classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${page}`).classList.add('active');
            
            if (page === 'users') {
                loadUsers();
            } else if (page === 'reports') {
                loadReports();
            }
        }

        async function loadStats() {
            const token = localStorage.getItem('token');
            
            try {
                const usersResponse = await fetch('/api/admin/users', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (usersResponse.ok) {
                    const users = await usersResponse.json();
                    document.getElementById('totalUsers').textContent = users.length;
                    
                    const establishments = users.filter(u => u.role === 'establishment').length;
                    document.getElementById('totalEstablishments').textContent = establishments;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadUsers() {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch('/api/admin/users', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const users = await response.json();
                    displayUsers(users);
                }
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        function displayUsers(users) {
            const list = document.getElementById('usersList');
            
            if (users.length === 0) {
                list.innerHTML = '<p class="text-[#2D3436] opacity-75">Aucun utilisateur</p>';
                return;
            }
            
            list.innerHTML = users.map(user => `
                <div class="bg-white rounded-2xl p-4">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-bold text-[#2D3436]">${user.name}</h4>
                        <span class="px-2 py-1 rounded-full text-xs font-semibold ${getRoleBadgeClass(user.role)}">
                            ${user.role}
                        </span>
                    </div>
                    <div class="text-sm text-[#2D3436] opacity-75 space-y-1">
                        <div>ðŸ“§ ${user.email}</div>
                        <div>ðŸŽ‚ ${user.age} ans â€¢ ${user.gender}</div>
                        <div>ðŸ’Ž ${user.subscription_tier}</div>
                    </div>
                </div>
            `).join('');
        }

        function getRoleBadgeClass(role) {
            switch(role) {
                case 'admin': return 'bg-[#FF4458] text-white';
                case 'establishment': return 'bg-[#6C5CE7] text-white';
                default: return 'bg-[#00B894] text-white';
            }
        }

        async function loadReports() {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch('/api/admin/reports', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const reports = await response.json();
                    displayReports(reports);
                    document.getElementById('totalReports').textContent = reports.length;
                }
            } catch (error) {
                console.error('Error loading reports:', error);
            }
        }

        function displayReports(reports) {
            const list = document.getElementById('reportsList');
            
            if (reports.length === 0) {
                list.innerHTML = '<p class="text-[#2D3436] opacity-75">Aucun signalement</p>';
                return;
            }
            
            list.innerHTML = reports.map(report => `
                <div class="bg-white rounded-2xl p-4 border-l-4 border-[#FF4458]">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-bold text-[#2D3436] capitalize">${report.report_type}</h4>
                        <span class="px-2 py-1 rounded-full text-xs font-semibold ${report.status === 'pending' ? 'bg-yellow-500 text-white' : 'bg-gray-300 text-[#2D3436]'}">
                            ${report.status}
                        </span>
                    </div>
                    <p class="text-sm text-[#2D3436] opacity-75 mb-2">${report.reason}</p>
                    <div class="text-xs text-[#2D3436] opacity-75">
                        Par ${report.reporter_name} â€¢ ${new Date(report.created_at).toLocaleDateString()}
                    </div>
                </div>
            `).join('');
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/';
        }

        checkAuth();
        loadStats();
    </script>
</body>
</html>
