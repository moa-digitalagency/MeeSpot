<!DOCTYPE html>
<!--
MeetSpot
MOA Digital Agency LLC
Par : Aisance KALONJI
Mail : moa@myoneart.com
www.myoneart.com
-->

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MeetSpot - Admin Dashboard</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#FF4458">
    <script src="/css/tailwind.js"></script>
    <link href="/css/fonts.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; padding-bottom: 80px; max-width: 768px; margin: 0 auto; }
        h1, h2, h3, h4, h5, h6 { font-family: 'Poppins', sans-serif; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; max-width: 768px; margin: 0 auto; background: white; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 50; }
        .nav-item { transition: all 0.2s; }
        .nav-item.active { color: #FF4458; }
        .nav-item svg { width: 24px; height: 24px; }
    </style>
</head>
<body class="bg-[#F5F5F5]">
    <div id="page-dashboard" class="page-content">
        <div class="px-4 pt-4">
            <div class="flex items-center justify-between mb-2">
                <div>
                    <h1 class="text-2xl font-bold text-[#2D3436] mb-1">Admin Dashboard</h1>
                    <p class="text-sm text-[#2D3436] opacity-75">Gestion de la plateforme</p>
                </div>
                <button onclick="logout()" class="px-4 py-2 bg-red-500 text-white rounded-full text-sm font-semibold hover:bg-red-600 transition">
                    🚪 Déconnexion
                </button>
            </div>
        </div>

        <div class="px-4 space-y-3 mb-4">
            <div class="bg-gradient-to-br from-[#FF4458] to-[#e03d4c] rounded-2xl p-5 text-white">
                <div class="text-sm opacity-90 mb-1">Utilisateurs totaux</div>
                <div id="totalUsers" class="text-3xl font-bold">0</div>
            </div>
            <div class="bg-gradient-to-br from-[#6C5CE7] to-[#5a4dd9] rounded-2xl p-5 text-white">
                <div class="text-sm opacity-90 mb-1">Rooms actives</div>
                <div id="totalRooms" class="text-3xl font-bold">0</div>
            </div>
            <div class="bg-gradient-to-br from-[#00B894] to-[#00a183] rounded-2xl p-5 text-white">
                <div class="text-sm opacity-90 mb-1">Établissements</div>
                <div id="totalEstablishments" class="text-3xl font-bold">0</div>
            </div>
            <div class="bg-gradient-to-br from-[#A29BFE] to-[#9189f7] rounded-2xl p-5 text-white">
                <div class="text-sm opacity-90 mb-1">Signalements en attente</div>
                <div id="totalReports" class="text-3xl font-bold">0</div>
            </div>
        </div>
    </div>

    <div id="page-users" class="page-content hidden">
        <div class="px-4 pt-4 pb-4">
            <div class="flex items-center justify-between mb-4">
                <h1 class="text-2xl font-bold text-[#2D3436]">Utilisateurs</h1>
                <button onclick="logout()" class="px-4 py-2 bg-red-500 text-white rounded-full text-sm font-semibold hover:bg-red-600 transition">
                    🚪 Déconnexion
                </button>
            </div>
            <div id="usersList" class="space-y-3">
                <p class="text-[#2D3436] opacity-75">Chargement...</p>
            </div>
        </div>
    </div>

    <div id="page-options" class="page-content hidden">
        <div class="px-4 pt-4 pb-4">
            <div class="flex items-center justify-between mb-2">
                <div>
                    <h1 class="text-2xl font-bold text-[#2D3436] mb-1">Options de Profil</h1>
                    <p class="text-sm text-[#2D3436] opacity-75">Gérer les options personnalisables</p>
                </div>
                <button onclick="logout()" class="px-4 py-2 bg-red-500 text-white rounded-full text-sm font-semibold hover:bg-red-600 transition">
                    🚪 Déconnexion
                </button>
            </div>
            
            <div class="space-y-4">
                <div class="bg-white rounded-2xl p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-bold text-[#2D3436]">⚧️ Genres</h3>
                        <button onclick="showAddOptionModal('gender')" class="px-3 py-1 bg-[#FF4458] text-white rounded-full text-sm">+ Ajouter</button>
                    </div>
                    <div id="genderOptions" class="space-y-2">
                        <p class="text-[#2D3436] opacity-75 text-sm">Chargement...</p>
                    </div>
                </div>
                
                <div class="bg-white rounded-2xl p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-bold text-[#2D3436]">🙏 Religions</h3>
                        <button onclick="showAddOptionModal('religion')" class="px-3 py-1 bg-[#FF4458] text-white rounded-full text-sm">+ Ajouter</button>
                    </div>
                    <div id="religionOptions" class="space-y-2">
                        <p class="text-[#2D3436] opacity-75 text-sm">Chargement...</p>
                    </div>
                </div>
                
                <div class="bg-white rounded-2xl p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-bold text-[#2D3436]">💕 Types de Rencontre</h3>
                        <button onclick="showAddOptionModal('meeting_type')" class="px-3 py-1 bg-[#FF4458] text-white rounded-full text-sm">+ Ajouter</button>
                    </div>
                    <div id="meetingTypeOptions" class="space-y-2">
                        <p class="text-[#2D3436] opacity-75 text-sm">Chargement...</p>
                    </div>
                </div>
                
                <div class="bg-white rounded-2xl p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-bold text-[#2D3436]">🎯 Centres d'Intérêt</h3>
                        <button onclick="showAddOptionModal('interest')" class="px-3 py-1 bg-[#FF4458] text-white rounded-full text-sm">+ Ajouter</button>
                    </div>
                    <div id="interestOptions" class="space-y-2">
                        <p class="text-[#2D3436] opacity-75 text-sm">Chargement...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="page-verifications" class="page-content hidden">
        <div class="px-4 pt-4 pb-4">
            <div class="flex items-center justify-between mb-4">
                <h1 class="text-2xl font-bold text-[#2D3436]">✓ Vérifications</h1>
                <button onclick="logout()" class="px-4 py-2 bg-red-500 text-white rounded-full text-sm font-semibold hover:bg-red-600 transition">
                    🚪 Déconnexion
                </button>
            </div>
            <div id="verificationsList" class="space-y-3">
                <p class="text-[#2D3436] opacity-75">Chargement...</p>
            </div>
        </div>
    </div>

    <div id="page-reports" class="page-content hidden">
        <div class="px-4 pt-4 pb-4">
            <div class="flex items-center justify-between mb-4">
                <h1 class="text-2xl font-bold text-[#2D3436]">Signalements</h1>
                <button onclick="logout()" class="px-4 py-2 bg-red-500 text-white rounded-full text-sm font-semibold hover:bg-red-600 transition">
                    🚪 Déconnexion
                </button>
            </div>
            <div id="reportsList" class="space-y-3">
                <p class="text-[#2D3436] opacity-75">Chargement...</p>
            </div>
        </div>
    </div>

    <div id="page-system" class="page-content hidden">
        <div class="px-4 pt-4 pb-4">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h1 class="text-2xl font-bold text-[#2D3436] mb-1">Système</h1>
                    <p class="text-sm text-[#2D3436] opacity-75">Backup, Mises à jour & Gestion</p>
                </div>
                <button onclick="logout()" class="px-4 py-2 bg-red-500 text-white rounded-full text-sm font-semibold hover:bg-red-600 transition">
                    🚪 Déconnexion
                </button>
            </div>

            <div class="space-y-4">
                <button onclick="switchPage('backups')" class="w-full bg-white rounded-2xl p-4 text-left hover:shadow-lg transition">
                    <h3 class="font-bold text-[#2D3436] mb-1">💾 Backup & Restauration</h3>
                    <p class="text-sm text-[#2D3436] opacity-75">Gérer les sauvegardes et restaurations</p>
                </button>

                <div class="bg-white rounded-2xl p-4">
                    <h3 class="font-bold text-[#2D3436] mb-3">🔄 Mise à Jour</h3>
                    <button onclick="updateFromGithub()" class="w-full py-3 bg-[#FF4458] text-white rounded-xl font-semibold hover:bg-[#e03d4c] transition">
                        🚀 Mettre à jour depuis GitHub
                    </button>
                </div>

                <div class="bg-white rounded-2xl p-4">
                    <h3 class="font-bold text-[#2D3436] mb-3">🗄️ Base de Données</h3>
                    <button onclick="migrateDatabase()" class="w-full py-3 bg-[#A29BFE] text-white rounded-xl font-semibold hover:bg-[#9189f7] transition">
                        🔧 Exécuter les Migrations
                    </button>
                </div>

                <button onclick="switchPage('apikeys')" class="w-full bg-white rounded-2xl p-4 text-left hover:shadow-lg transition">
                    <h3 class="font-bold text-[#2D3436] mb-1">🔑 Clés API</h3>
                    <p class="text-sm text-[#2D3436] opacity-75">Générer et gérer les clés API</p>
                </button>

                <button onclick="switchPage('logs')" class="w-full bg-white rounded-2xl p-4 text-left hover:shadow-lg transition">
                    <h3 class="font-bold text-[#2D3436] mb-1">📝 Logs Système</h3>
                    <p class="text-sm text-[#2D3436] opacity-75">Visualiser les logs de l'application</p>
                </button>
            </div>
        </div>
    </div>

    <div id="page-backups" class="page-content hidden">
        <div class="px-4 pt-4 pb-4">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <button onclick="switchPage('system')" class="w-10 h-10 flex items-center justify-center bg-gray-100 text-gray-600 hover:bg-gray-200 rounded-full transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                    </button>
                    <h1 class="text-2xl font-bold text-[#2D3436]">💾 Backups</h1>
                </div>
            </div>

            <button onclick="createBackup()" class="w-full mb-4 py-3 bg-[#00B894] text-white rounded-xl font-semibold hover:bg-[#00a183] transition">
                📦 Créer un Nouveau Backup
            </button>

            <div id="backupsList" class="space-y-3">
                <p class="text-[#2D3436] opacity-75">Chargement...</p>
            </div>
        </div>
    </div>

    <div id="page-apikeys" class="page-content hidden">
        <div class="px-4 pt-4 pb-4">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <button onclick="switchPage('system')" class="w-10 h-10 flex items-center justify-center bg-gray-100 text-gray-600 hover:bg-gray-200 rounded-full transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                    </button>
                    <h1 class="text-2xl font-bold text-[#2D3436]">🔑 Clés API</h1>
                </div>
            </div>

            <button onclick="generateApiKey()" class="w-full mb-4 py-3 bg-[#6C5CE7] text-white rounded-xl font-semibold hover:bg-[#5a4dd9] transition">
                ➕ Générer une Nouvelle Clé
            </button>

            <div id="apiKeysList" class="space-y-3">
                <p class="text-[#2D3436] opacity-75">Chargement...</p>
            </div>
        </div>
    </div>

    <div id="page-logs" class="page-content hidden">
        <div class="px-4 pt-4 pb-4">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <button onclick="switchPage('system')" class="w-10 h-10 flex items-center justify-center bg-gray-100 text-gray-600 hover:bg-gray-200 rounded-full transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                    </button>
                    <h1 class="text-2xl font-bold text-[#2D3436]">📝 Logs Système</h1>
                </div>
            </div>

            <button onclick="refreshLogs()" class="w-full mb-4 py-3 bg-[#636E72] text-white rounded-xl font-semibold hover:bg-[#545d61] transition">
                🔄 Rafraîchir les Logs
            </button>

            <div id="logsList" class="space-y-3">
                <p class="text-[#2D3436] opacity-75">Chargement...</p>
            </div>
        </div>
    </div>

    <div id="addOptionModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-3xl w-full max-w-md m-4 p-6">
            <h3 class="text-xl font-bold text-[#2D3436] mb-4">Ajouter une Option</h3>
            <form onsubmit="addOption(event)">
                <input type="hidden" id="newOptionCategory">
                <div class="mb-3">
                    <label class="block text-[#2D3436] mb-2 text-sm font-semibold">Valeur (ID)</label>
                    <input type="text" id="newOptionValue" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:border-[#FF4458]" placeholder="ex: pansexual">
                </div>
                <div class="mb-4">
                    <label class="block text-[#2D3436] mb-2 text-sm font-semibold">Libellé</label>
                    <input type="text" id="newOptionLabel" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:border-[#FF4458]" placeholder="ex: Pansexuel(le)">
                </div>
                <div class="flex gap-2">
                    <button type="button" onclick="closeAddOptionModal()" class="flex-1 py-3 bg-gray-200 text-[#2D3436] rounded-full">Annuler</button>
                    <button type="submit" class="flex-1 py-3 bg-[#FF4458] text-white rounded-full">Ajouter</button>
                </div>
            </form>
        </div>
    </div>

    <div id="userDetailsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-end z-50">
        <div class="bg-white rounded-t-3xl w-full p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-[#2D3436]">Détails Utilisateur</h3>
                <button onclick="closeUserDetailsModal()" class="w-10 h-10 flex items-center justify-center bg-gray-100 text-gray-600 hover:bg-gray-200 rounded-full text-2xl font-bold transition-colors">×</button>
            </div>
            <div id="userDetailsContent" class="space-y-4">
                <p class="text-sm text-[#2D3436] opacity-75 text-center py-4">Chargement...</p>
            </div>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="grid grid-cols-6 h-16">
            <button onclick="switchPage('dashboard')" id="nav-dashboard" class="nav-item active flex flex-col items-center justify-center">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                </svg>
                <span class="text-xs mt-1">Stats</span>
            </button>
            <button onclick="switchPage('users')" id="nav-users" class="nav-item flex flex-col items-center justify-center">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                </svg>
                <span class="text-xs mt-1">Users</span>
            </button>
            <button onclick="switchPage('options')" id="nav-options" class="nav-item flex flex-col items-center justify-center">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                <span class="text-xs mt-1">Options</span>
            </button>
            <button onclick="switchPage('verifications')" id="nav-verifications" class="nav-item flex flex-col items-center justify-center">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span class="text-xs mt-1">Verify</span>
            </button>
            <button onclick="switchPage('reports')" id="nav-reports" class="nav-item flex flex-col items-center justify-center">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
                <span class="text-xs mt-1">Reports</span>
            </button>
            <button onclick="switchPage('system')" id="nav-system" class="nav-item flex flex-col items-center justify-center">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"/>
                </svg>
                <span class="text-xs mt-1">Système</span>
            </button>
        </div>
    </div>

    <script>
        let currentPage = 'dashboard';

        function checkAuth() {
            const token = localStorage.getItem('token');
            const userData = localStorage.getItem('user');
            if (!token || !userData) {
                window.location.href = '/';
                return;
            }
            const user = JSON.parse(userData);
            if (user.role !== 'admin') {
                window.location.href = '/app.html';
            }
        }

        function switchPage(page) {
            currentPage = page;
            
            document.querySelectorAll('.page-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`page-${page}`).classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${page}`).classList.add('active');
            
            if (page === 'users') {
                loadUsers();
            } else if (page === 'reports') {
                loadReports();
            } else if (page === 'options') {
                loadProfileOptions();
            } else if (page === 'verifications') {
                loadVerifications();
            } else if (page === 'backups') {
                loadBackups();
            } else if (page === 'apikeys') {
                loadApiKeys();
            } else if (page === 'logs') {
                loadSystemLogs();
            }
        }

        async function loadStats() {
            const token = localStorage.getItem('token');
            
            try {
                // Charger les utilisateurs
                const usersResponse = await fetch('/api/admin/users', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (usersResponse.ok) {
                    const users = await usersResponse.json();
                    document.getElementById('totalUsers').textContent = users.length;
                    
                    const establishments = users.filter(u => u.role === 'establishment').length;
                    document.getElementById('totalEstablishments').textContent = establishments;
                }
                
                // Charger les rooms
                const roomsResponse = await fetch('/api/rooms', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (roomsResponse.ok) {
                    const rooms = await roomsResponse.json();
                    const now = new Date();
                    const activeRooms = rooms.filter(r => new Date(r.expires_at) > now);
                    document.getElementById('totalRooms').textContent = activeRooms.length;
                }
                
                // Charger les signalements
                const reportsResponse = await fetch('/api/admin/reports', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (reportsResponse.ok) {
                    const reports = await reportsResponse.json();
                    const pendingReports = reports.filter(r => r.status === 'pending');
                    document.getElementById('totalReports').textContent = pendingReports.length;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
                alert('Erreur lors du chargement des statistiques. Veuillez vous reconnecter.');
            }
        }

        async function loadUsers() {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch('/api/admin/users', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const users = await response.json();
                    displayUsers(users);
                }
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        function displayUsers(users) {
            const list = document.getElementById('usersList');
            
            if (users.length === 0) {
                list.innerHTML = '<p class="text-[#2D3436] opacity-75">Aucun utilisateur</p>';
                return;
            }
            
            list.innerHTML = users.map(user => `
                <div class="bg-white rounded-2xl p-4">
                    <div class="flex items-start gap-3 mb-3">
                        ${user.photo_url ? `
                            <img src="${user.photo_url}" alt="${user.name}" class="w-16 h-16 rounded-full object-cover">
                        ` : `
                            <div class="w-16 h-16 rounded-full bg-[#6C5CE7] flex items-center justify-center text-white text-xl font-bold">
                                ${user.name ? user.name.charAt(0).toUpperCase() : '?'}
                            </div>
                        `}
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="font-bold text-[#2D3436]">${user.name}${user.is_verified ? ' <span class="text-blue-500" title="Vérifié">✓</span>' : ''}</h4>
                                <span class="px-2 py-1 rounded-full text-xs font-semibold ${getRoleBadgeClass(user.role)}">
                                    ${user.role}
                                </span>
                            </div>
                            <div class="text-sm text-[#2D3436] opacity-75 space-y-1">
                                <div>📧 ${user.email}</div>
                                <div>🎂 ${user.age || 'N/A'} ans • ${user.gender || 'N/A'}</div>
                                <div>💎 ${user.subscription_tier || 'free'}</div>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="viewUserDetails(${user.id})" class="flex-1 py-2 bg-[#6C5CE7] text-white rounded-full text-sm font-semibold hover:bg-[#5f52d6] transition">
                            👁️ Voir
                        </button>
                        <button onclick="toggleUserBlock(${user.id}, ${user.is_blocked || false})" class="flex-1 py-2 ${user.is_blocked ? 'bg-green-500 hover:bg-green-600' : 'bg-yellow-500 hover:bg-yellow-600'} text-white rounded-full text-sm font-semibold transition">
                            ${user.is_blocked ? '✅ Débloquer' : '🚫 Bloquer'}
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function getRoleBadgeClass(role) {
            switch(role) {
                case 'admin': return 'bg-[#FF4458] text-white';
                case 'establishment': return 'bg-[#6C5CE7] text-white';
                default: return 'bg-[#00B894] text-white';
            }
        }

        async function loadReports() {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch('/api/admin/reports', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const reports = await response.json();
                    displayReports(reports);
                    document.getElementById('totalReports').textContent = reports.length;
                }
            } catch (error) {
                console.error('Error loading reports:', error);
            }
        }

        function displayReports(reports) {
            const list = document.getElementById('reportsList');
            
            if (reports.length === 0) {
                list.innerHTML = '<p class="text-[#2D3436] opacity-75">Aucun signalement</p>';
                return;
            }
            
            list.innerHTML = reports.map(report => `
                <div class="bg-white rounded-2xl p-4 border-l-4 border-[#FF4458]">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-bold text-[#2D3436] capitalize">${report.report_type}</h4>
                        <span class="px-2 py-1 rounded-full text-xs font-semibold ${report.status === 'pending' ? 'bg-yellow-500 text-white' : 'bg-gray-300 text-[#2D3436]'}">
                            ${report.status}
                        </span>
                    </div>
                    <p class="text-sm text-[#2D3436] opacity-75 mb-2">${report.reason}</p>
                    <div class="text-xs text-[#2D3436] opacity-75">
                        Par ${report.reporter_name} • ${new Date(report.created_at).toLocaleDateString()}
                    </div>
                </div>
            `).join('');
        }

        async function loadVerifications() {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch('/api/verification/admin/list?status=pending', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayVerifications(data.verifications || []);
                }
            } catch (error) {
                console.error('Error loading verifications:', error);
            }
        }

        function displayVerifications(verifications) {
            const list = document.getElementById('verificationsList');
            
            if (verifications.length === 0) {
                list.innerHTML = '<p class="text-[#2D3436] opacity-75">Aucune demande en attente</p>';
                return;
            }
            
            list.innerHTML = verifications.map((v, index) => {
                const verificationId = `verification_${v.id}`;
                window[verificationId] = v;
                
                return `
                <div class="bg-white rounded-2xl p-4 border-l-4 border-[#6C5CE7]">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <h4 class="font-bold text-[#2D3436]">${v.user_name}</h4>
                            <p class="text-xs text-[#2D3436] opacity-75">${v.user_email}</p>
                            ${v.user_gender ? `<p class="text-xs text-[#2D3436] opacity-75">${v.user_gender}${v.user_age ? `, ${v.user_age} ans` : ''}</p>` : ''}
                        </div>
                        <span class="px-2 py-1 rounded-full text-xs font-semibold bg-yellow-500 text-white">
                            En attente
                        </span>
                    </div>
                    <div class="mb-3 cursor-pointer" onclick="showImageFullscreen('${v.photo_url}')">
                        <img src="${v.photo_url}" alt="Verification Photo" class="w-full rounded-xl object-cover hover:opacity-90 transition" style="max-height: 400px;">
                        <p class="text-xs text-center text-[#6C5CE7] mt-1">🔍 Cliquer pour agrandir</p>
                    </div>
                    <div class="text-xs text-[#2D3436] opacity-75 mb-3">
                        Demandé le ${new Date(v.created_at).toLocaleDateString()}
                    </div>
                    <div class="flex gap-2">
                        <button onclick="showUserProfile('${verificationId}')" class="flex-1 py-2 bg-[#6C5CE7] text-white rounded-full text-sm font-semibold hover:bg-[#5b4cc6] transition">
                            👤 Voir profil
                        </button>
                        <button onclick="approveVerification(${v.id})" class="flex-1 py-2 bg-green-500 text-white rounded-full text-sm font-semibold hover:bg-green-600 transition">
                            ✓ Approuver
                        </button>
                        <button onclick="rejectVerification(${v.id})" class="flex-1 py-2 bg-red-500 text-white rounded-full text-sm font-semibold hover:bg-red-600 transition">
                            ✗ Rejeter
                        </button>
                    </div>
                </div>
            `;
            }).join('');
        }

        async function approveVerification(requestId) {
            if (!confirm('Approuver cette demande de vérification ?')) return;
            
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch(`/api/verification/admin/${requestId}/approve`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('✓ Vérification approuvée !');
                    loadVerifications();
                } else {
                    alert(`Erreur: ${data.message || 'Erreur lors de l\'approbation'}`);
                }
            } catch (error) {
                console.error('Error approving verification:', error);
                alert(`Erreur: ${error.message}`);
            }
        }

        async function rejectVerification(requestId) {
            if (!confirm('Rejeter cette demande de vérification ?')) return;
            
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch(`/api/verification/admin/${requestId}/reject`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    alert('Demande rejetée');
                    loadVerifications();
                } else {
                    alert('Erreur lors du rejet');
                }
            } catch (error) {
                console.error('Error rejecting verification:', error);
                alert('Erreur lors du rejet');
            }
        }

        function showImageFullscreen(imageUrl) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modal.classList.remove('hidden');
            modalImg.src = imageUrl;
        }

        function closeImageModal() {
            document.getElementById('imageModal').classList.add('hidden');
        }

        async function showUserProfile(verificationId) {
            const user = window[verificationId];
            if (!user) return;
            
            const modal = document.getElementById('profileModal');
            const content = document.getElementById('profileContent');
            const token = localStorage.getItem('token');
            
            // Charger le profil complet de l'utilisateur
            try {
                const response = await fetch(`/api/admin/users/${user.user_id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const fullUser = await response.json();
                    
                    content.innerHTML = `
                        <div class="text-center mb-4">
                            ${fullUser.photo_url ? `
                                <img src="${fullUser.photo_url}" alt="${fullUser.name}" class="w-32 h-32 rounded-full object-cover mx-auto mb-3 cursor-pointer" onclick="showImageFullscreen('${fullUser.photo_url}')">
                            ` : `
                                <div class="w-32 h-32 rounded-full bg-[#6C5CE7] flex items-center justify-center text-white text-4xl font-bold mx-auto mb-3">
                                    ${fullUser.name ? fullUser.name.charAt(0).toUpperCase() : '?'}
                                </div>
                            `}
                            <h3 class="text-xl font-bold text-[#2D3436]">${fullUser.name}</h3>
                            <p class="text-sm text-[#2D3436] opacity-75">${fullUser.email}</p>
                        </div>
                        
                        <div class="space-y-3">
                            ${fullUser.gender ? `
                                <div class="bg-[#F5F5F5] rounded-xl p-3">
                                    <p class="text-xs font-semibold text-[#2D3436] mb-1">Genre</p>
                                    <p class="text-sm text-[#2D3436]">${fullUser.gender}</p>
                                </div>
                            ` : ''}
                            
                            ${fullUser.age ? `
                                <div class="bg-[#F5F5F5] rounded-xl p-3">
                                    <p class="text-xs font-semibold text-[#2D3436] mb-1">Âge</p>
                                    <p class="text-sm text-[#2D3436]">${fullUser.age} ans</p>
                                </div>
                            ` : ''}
                            
                            ${fullUser.sexual_orientation ? `
                                <div class="bg-[#F5F5F5] rounded-xl p-3">
                                    <p class="text-xs font-semibold text-[#2D3436] mb-1">Orientation</p>
                                    <p class="text-sm text-[#2D3436]">${fullUser.sexual_orientation}</p>
                                </div>
                            ` : ''}
                            
                            ${fullUser.bio ? `
                                <div class="bg-[#F5F5F5] rounded-xl p-3">
                                    <p class="text-xs font-semibold text-[#2D3436] mb-1">Bio</p>
                                    <p class="text-sm text-[#2D3436]">${fullUser.bio}</p>
                                </div>
                            ` : ''}
                            
                            ${fullUser.gallery_photos && fullUser.gallery_photos.length > 0 ? `
                                <div class="bg-[#F5F5F5] rounded-xl p-3">
                                    <p class="text-xs font-semibold text-[#2D3436] mb-2">Galerie photos</p>
                                    <div class="grid grid-cols-3 gap-2">
                                        ${fullUser.gallery_photos.map(photo => `
                                            <img src="${photo}" alt="Gallery" class="w-full h-20 object-cover rounded-lg cursor-pointer" onclick="showImageFullscreen('${photo}')">
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div class="bg-[#F5F5F5] rounded-xl p-3">
                                <p class="text-xs font-semibold text-[#2D3436] mb-1">Demande de vérification</p>
                                <p class="text-sm text-[#2D3436]">Demandé le ${new Date(user.created_at).toLocaleDateString()}</p>
                            </div>
                        </div>
                    `;
                } else {
                    // Fallback sur les données limitées si l'API échoue
                    content.innerHTML = `<p class="text-red-500">Erreur lors du chargement du profil complet</p>`;
                }
            } catch (error) {
                content.innerHTML = `<p class="text-red-500">Erreur: ${error.message}</p>`;
            }
            
            modal.classList.remove('hidden');
        }

        function closeProfileModal() {
            document.getElementById('profileModal').classList.add('hidden');
        }

        async function loadProfileOptions() {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch('/api/profile-options', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const options = await response.json();
                    displayProfileOptions(options);
                }
            } catch (error) {
                console.error('Error loading profile options:', error);
            }
        }

        function displayProfileOptions(options) {
            displayCategoryOptions('gender', options.gender || []);
            displayCategoryOptions('religion', options.religion || []);
            displayCategoryOptions('meeting_type', options.meeting_type || []);
            displayCategoryOptions('interest', options.interest || []);
        }

        function displayCategoryOptions(category, opts) {
            const containerMap = {
                'gender': 'genderOptions',
                'religion': 'religionOptions',
                'meeting_type': 'meetingTypeOptions',
                'interest': 'interestOptions'
            };
            const containerId = containerMap[category] || 'genderOptions';
            const container = document.getElementById(containerId);
            
            if (opts.length === 0) {
                container.innerHTML = '<p class="text-[#2D3436] opacity-75 text-sm">Aucune option</p>';
                return;
            }
            
            container.innerHTML = opts.map(opt => `
                <div class="flex items-center justify-between py-2 px-3 bg-gray-50 rounded-xl">
                    <div>
                        <span class="font-semibold text-[#2D3436]">${opt.label}</span>
                        <span class="text-xs text-gray-500 ml-2">(${opt.value})</span>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" ${opt.is_active ? 'checked' : ''} onchange="toggleOption(${opt.id})" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                    </label>
                </div>
            `).join('');
        }

        function showAddOptionModal(category) {
            document.getElementById('newOptionCategory').value = category;
            document.getElementById('addOptionModal').classList.remove('hidden');
        }

        function closeAddOptionModal() {
            document.getElementById('addOptionModal').classList.add('hidden');
            document.getElementById('newOptionValue').value = '';
            document.getElementById('newOptionLabel').value = '';
        }

        async function addOption(e) {
            e.preventDefault();
            const token = localStorage.getItem('token');
            
            const data = {
                category: document.getElementById('newOptionCategory').value,
                value: document.getElementById('newOptionValue').value,
                label: document.getElementById('newOptionLabel').value
            };
            
            try {
                const response = await fetch('/api/profile-options', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    closeAddOptionModal();
                    loadProfileOptions();
                    alert('Option ajoutée avec succès!');
                } else {
                    const error = await response.json();
                    alert(error.message || 'Erreur lors de l\'ajout');
                }
            } catch (error) {
                console.error('Error adding option:', error);
                alert('Erreur de connexion');
            }
        }

        async function toggleOption(optionId) {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch(`/api/profile-options/${optionId}/toggle`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    loadProfileOptions();
                } else {
                    alert('Erreur lors du changement de statut');
                }
            } catch (error) {
                console.error('Error toggling option:', error);
                alert('Erreur de connexion');
            }
        }

        async function viewUserDetails(userId) {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch(`/api/admin/users/${userId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const user = await response.json();
                    displayUserDetails(user);
                    document.getElementById('userDetailsModal').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading user details:', error);
                alert('Erreur lors du chargement des détails');
            }
        }

        function displayUserDetails(user) {
            const content = document.getElementById('userDetailsContent');
            content.innerHTML = `
                <div class="bg-white rounded-2xl p-4 border border-gray-200">
                    ${user.photo_url ? `<img src="${user.photo_url}" class="w-32 h-32 rounded-full mx-auto mb-4 object-cover cursor-pointer" onclick="showImageFullscreen('${user.photo_url}')">` : '<div class="w-32 h-32 rounded-full mx-auto mb-4 bg-gray-200 flex items-center justify-center text-4xl">👤</div>'}
                    <h3 class="text-xl font-bold text-center text-[#2D3436] mb-4">${user.name}${user.is_verified ? ' <span class="text-blue-500">✓</span>' : ''}</h3>
                    
                    <div class="space-y-3 text-[#2D3436]">
                        <div class="flex justify-between py-2 border-b">
                            <span class="font-semibold">Email:</span>
                            <span>${user.email}</span>
                        </div>
                        <div class="flex justify-between py-2 border-b">
                            <span class="font-semibold">Rôle:</span>
                            <span class="px-2 py-1 rounded-full text-xs font-semibold ${getRoleBadgeClass(user.role)}">${user.role}</span>
                        </div>
                        <div class="flex justify-between py-2 border-b">
                            <span class="font-semibold">Âge:</span>
                            <span>${user.age || 'N/A'} ans</span>
                        </div>
                        <div class="flex justify-between py-2 border-b">
                            <span class="font-semibold">Genre:</span>
                            <span>${user.gender || 'N/A'}</span>
                        </div>
                        ${user.sexual_orientation ? `
                        <div class="flex justify-between py-2 border-b">
                            <span class="font-semibold">Orientation:</span>
                            <span>${user.sexual_orientation}</span>
                        </div>
                        ` : ''}
                        <div class="flex justify-between py-2 border-b">
                            <span class="font-semibold">Abonnement:</span>
                            <span class="uppercase font-bold">${user.subscription_tier || 'free'}</span>
                        </div>
                        ${user.bio ? `
                        <div class="py-2 border-b">
                            <span class="font-semibold block mb-2">Bio:</span>
                            <p class="text-sm opacity-75">${user.bio}</p>
                        </div>` : ''}
                        ${user.gallery_photos && user.gallery_photos.length > 0 ? `
                        <div class="py-2 border-b">
                            <span class="font-semibold block mb-2">Galerie photos:</span>
                            <div class="grid grid-cols-3 gap-2">
                                ${user.gallery_photos.map(photo => `
                                    <img src="${photo}" alt="Gallery" class="w-full h-20 object-cover rounded-lg cursor-pointer" onclick="showImageFullscreen('${photo}')">
                                `).join('')}
                            </div>
                        </div>` : ''}
                        <div class="flex justify-between py-2 border-b">
                            <span class="font-semibold">Inscription:</span>
                            <span class="text-sm">${new Date(user.created_at).toLocaleDateString()}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function closeUserDetailsModal() {
            document.getElementById('userDetailsModal').classList.add('hidden');
        }

        async function toggleUserBlock(userId, isCurrentlyBlocked) {
            const action = isCurrentlyBlocked ? 'débloquer' : 'bloquer';
            if (!confirm(`Voulez-vous vraiment ${action} cet utilisateur ?`)) {
                return;
            }

            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch(`/api/admin/users/${userId}/block`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_blocked: !isCurrentlyBlocked })
                });
                
                if (response.ok) {
                    alert(`Utilisateur ${action === 'bloquer' ? 'bloqué' : 'débloqué'} avec succès!`);
                    loadUsers();
                } else {
                    const error = await response.json();
                    alert(error.message || `Erreur lors du ${action}`);
                }
            } catch (error) {
                console.error('Error toggling user block:', error);
                alert('Erreur de connexion');
            }
        }

        async function createBackup() {
            if (!confirm('Créer un backup complet de l\'application ?')) return;
            
            const token = localStorage.getItem('token');
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = '⏳ Création en cours...';
            
            try {
                const response = await fetch('/api/admin/backup/create', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('✅ ' + data.message);
                } else {
                    alert('❌ ' + data.message);
                }
            } catch (error) {
                alert('Erreur lors de la création du backup');
            } finally {
                btn.disabled = false;
                btn.textContent = '📦 Créer un Backup';
            }
        }

        async function viewBackups() {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch('/api/admin/backup/list', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                if (data.success && data.backups) {
                    let msg = '📂 Backups disponibles:\n\n';
                    data.backups.forEach(b => {
                        msg += `📦 ${b.name}\n   ${b.size_mb} MB - ${new Date(b.date * 1000).toLocaleString()}\n\n`;
                    });
                    alert(msg || 'Aucun backup disponible');
                }
            } catch (error) {
                alert('Erreur lors du chargement des backups');
            }
        }

        async function updateFromGithub() {
            if (!confirm('⚠️ Cette action va mettre à jour l\'application depuis GitHub.\nUn backup sera créé automatiquement.\n\nContinuer ?')) return;
            
            const token = localStorage.getItem('token');
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = '⏳ Mise à jour en cours...';
            
            try {
                const response = await fetch('/api/admin/update', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('✅ ' + data.message + '\n\n' + data.output);
                    setTimeout(() => window.location.reload(), 2000);
                } else {
                    alert('❌ ' + data.message + '\n\n' + (data.error || data.output));
                }
            } catch (error) {
                alert('Erreur lors de la mise à jour');
            } finally {
                btn.disabled = false;
                btn.textContent = '🚀 Mettre à jour depuis GitHub';
            }
        }

        async function migrateDatabase() {
            if (!confirm('Exécuter les migrations de base de données ?')) return;
            
            const token = localStorage.getItem('token');
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = '⏳ Migration en cours...';
            
            try {
                const response = await fetch('/api/admin/database/migrate', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('✅ ' + data.message + '\n\n' + data.output);
                } else {
                    alert('❌ ' + data.message + '\n\n' + (data.error || data.output));
                }
            } catch (error) {
                alert('Erreur lors de la migration');
            } finally {
                btn.disabled = false;
                btn.textContent = '🔧 Exécuter les Migrations';
            }
        }

        async function viewApiKeys() {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch('/api/admin/api-keys', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                if (data.success && data.keys) {
                    let msg = '🔑 Clés API:\n\n';
                    data.keys.forEach(k => {
                        msg += `${k.is_active ? '✅' : '❌'} ${k.name}\n   Créée: ${new Date(k.created_at).toLocaleDateString()}\n\n`;
                    });
                    alert(msg || 'Aucune clé API');
                }
            } catch (error) {
                alert('Erreur lors du chargement des clés API');
            }
        }

        async function viewLogs() {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch('/api/admin/logs/list', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                if (data.success && data.logs) {
                    let msg = '📝 Logs disponibles:\n\n';
                    data.logs.forEach(l => {
                        msg += `📄 ${l.name}\n   ${(l.size / 1024).toFixed(2)} KB\n\n`;
                    });
                    alert(msg || 'Aucun log disponible');
                }
            } catch (error) {
                alert('Erreur lors du chargement des logs');
            }
        }

        // BACKUPS MANAGEMENT
        async function loadBackups() {
            const token = localStorage.getItem('token');
            const list = document.getElementById('backupsList');
            
            try {
                const response = await fetch('/api/admin/backup/list', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                if (data.success && data.backups) {
                    if (data.backups.length === 0) {
                        list.innerHTML = '<p class="text-[#2D3436] opacity-75">Aucun backup disponible</p>';
                        return;
                    }
                    
                    list.innerHTML = data.backups.map(b => `
                        <div class="bg-white rounded-2xl p-4 border-l-4 border-[#00B894]">
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="font-bold text-[#2D3436]">${b.name}</h4>
                                <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">${(b.size / 1024 / 1024).toFixed(2)} MB</span>
                            </div>
                            <p class="text-xs text-[#2D3436] opacity-75 mb-3">${new Date(b.created).toLocaleString()}</p>
                            <div class="flex gap-2">
                                <button onclick="restoreBackup('${b.name}')" class="flex-1 py-2 bg-[#6C5CE7] text-white rounded-full text-sm font-semibold hover:bg-[#5a4dd9] transition">
                                    🔄 Restaurer
                                </button>
                                <button onclick="deleteBackup('${b.name}')" class="flex-1 py-2 bg-red-500 text-white rounded-full text-sm font-semibold hover:bg-red-600 transition">
                                    🗑️ Supprimer
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    list.innerHTML = '<p class="text-[#2D3436] opacity-75">Erreur lors du chargement</p>';
                }
            } catch (error) {
                list.innerHTML = '<p class="text-red-500">Erreur lors du chargement des backups</p>';
            }
        }

        async function restoreBackup(filename) {
            if (!confirm(`⚠️ Attention! La restauration va écraser toutes les données actuelles. Continuer?`)) return;
            
            const token = localStorage.getItem('token');
            try {
                const response = await fetch('/api/admin/backup/restore', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ filename })
                });
                
                const data = await response.json();
                alert(data.success ? '✓ Backup restauré avec succès!' : `Erreur: ${data.message}`);
                if (data.success) loadBackups();
            } catch (error) {
                alert('Erreur lors de la restauration');
            }
        }

        async function deleteBackup(filename) {
            if (!confirm(`Supprimer le backup ${filename}?`)) return;
            
            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`/api/admin/backup/delete/${filename}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                alert(data.success ? '✓ Backup supprimé!' : `Erreur: ${data.message}`);
                if (data.success) loadBackups();
            } catch (error) {
                alert('Erreur lors de la suppression');
            }
        }

        // API KEYS MANAGEMENT
        async function loadApiKeys() {
            const token = localStorage.getItem('token');
            const list = document.getElementById('apiKeysList');
            
            try {
                const response = await fetch('/api/admin/apikeys/list', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                if (data.success && data.keys) {
                    if (data.keys.length === 0) {
                        list.innerHTML = '<p class="text-[#2D3436] opacity-75">Aucune clé API</p>';
                        return;
                    }
                    
                    list.innerHTML = data.keys.map(k => `
                        <div class="bg-white rounded-2xl p-4 border-l-4 border-[#6C5CE7]">
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="font-bold text-[#2D3436]">${k.name}</h4>
                                <span class="text-xs ${k.is_active ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'} px-2 py-1 rounded-full">
                                    ${k.is_active ? 'Active' : 'Révoquée'}
                                </span>
                            </div>
                            <p class="text-xs font-mono text-[#2D3436] bg-gray-100 p-2 rounded mb-2">${k.key}</p>
                            <p class="text-xs text-[#2D3436] opacity-75 mb-3">Créée le ${new Date(k.created_at).toLocaleString()}</p>
                            <div class="flex gap-2">
                                ${k.is_active ? `
                                <button onclick="revokeApiKey(${k.id})" class="flex-1 py-2 bg-orange-500 text-white rounded-full text-sm font-semibold hover:bg-orange-600 transition">
                                    🔒 Révoquer
                                </button>
                                ` : ''}
                                <button onclick="deleteApiKey(${k.id})" class="flex-1 py-2 bg-red-500 text-white rounded-full text-sm font-semibold hover:bg-red-600 transition">
                                    🗑️ Supprimer
                                </button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                list.innerHTML = '<p class="text-red-500">Erreur lors du chargement des clés API</p>';
            }
        }

        async function generateApiKey() {
            const name = prompt('Nom de la clé API:');
            if (!name) return;
            
            const token = localStorage.getItem('token');
            try {
                const response = await fetch('/api/admin/apikeys/create', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert(`✓ Clé générée!\n\n${data.key.key}\n\nCopiez-la maintenant, elle ne sera plus affichée.`);
                    loadApiKeys();
                } else {
                    alert(`Erreur: ${data.message}`);
                }
            } catch (error) {
                alert('Erreur lors de la génération');
            }
        }

        async function revokeApiKey(keyId) {
            if (!confirm('Révoquer cette clé API?')) return;
            
            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`/api/admin/apikeys/${keyId}/revoke`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                alert(data.success ? '✓ Clé révoquée!' : `Erreur: ${data.message}`);
                if (data.success) loadApiKeys();
            } catch (error) {
                alert('Erreur lors de la révocation');
            }
        }

        async function deleteApiKey(keyId) {
            if (!confirm('Supprimer définitivement cette clé API?')) return;
            
            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`/api/admin/apikeys/${keyId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                alert(data.success ? '✓ Clé supprimée!' : `Erreur: ${data.message}`);
                if (data.success) loadApiKeys();
            } catch (error) {
                alert('Erreur lors de la suppression');
            }
        }

        // LOGS MANAGEMENT
        async function loadSystemLogs() {
            const token = localStorage.getItem('token');
            const list = document.getElementById('logsList');
            
            try {
                const response = await fetch('/api/admin/logs/list', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                if (data.success && data.logs) {
                    if (data.logs.length === 0) {
                        list.innerHTML = '<p class="text-[#2D3436] opacity-75">Aucun log disponible</p>';
                        return;
                    }
                    
                    list.innerHTML = data.logs.map(l => `
                        <div class="bg-white rounded-2xl p-4">
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="font-bold text-[#2D3436]">${l.name}</h4>
                                <span class="text-xs bg-gray-100 text-[#2D3436] px-2 py-1 rounded-full">${(l.size / 1024).toFixed(2)} KB</span>
                            </div>
                            <button onclick="viewLogContent('${l.name}')" class="w-full py-2 bg-[#636E72] text-white rounded-full text-sm font-semibold hover:bg-[#545d61] transition">
                                👁️ Voir le contenu
                            </button>
                        </div>
                    `).join('');
                }
            } catch (error) {
                list.innerHTML = '<p class="text-red-500">Erreur lors du chargement des logs</p>';
            }
        }

        async function refreshLogs() {
            loadSystemLogs();
        }

        async function viewLogContent(logName) {
            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`/api/admin/logs/view/${logName}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                if (data.success) {
                    alert(`📝 ${logName}\n\n${data.content.substring(0, 1000)}${data.content.length > 1000 ? '\n\n... (tronqué)' : ''}`);
                } else {
                    alert(`Erreur: ${data.message}`);
                }
            } catch (error) {
                alert('Erreur lors de la lecture du log');
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/';
        }

        checkAuth();
        loadStats();
    </script>

    <!-- Modal pour afficher l'image en plein écran -->
    <div id="imageModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50" onclick="closeImageModal()">
        <div class="relative max-w-4xl max-h-screen p-4">
            <button onclick="closeImageModal()" class="absolute top-6 right-6 text-white text-4xl font-bold hover:text-gray-300 transition z-10">
                ✕
            </button>
            <img id="modalImage" src="" alt="Full screen" class="max-w-full max-h-screen rounded-xl">
        </div>
    </div>

    <!-- Modal pour afficher le profil de l'utilisateur -->
    <div id="profileModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-[#2D3436]">👤 Profil de l'utilisateur</h2>
                <button onclick="closeProfileModal()" class="text-2xl text-[#2D3436] hover:text-[#FF4458] transition">
                    ✕
                </button>
            </div>
            <div id="profileContent">
                <!-- Contenu dynamique -->
            </div>
        </div>
    </div>
</body>
</html>
