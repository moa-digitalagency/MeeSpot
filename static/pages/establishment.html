<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MeetSpot - Establishment Dashboard</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#FF4458">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; padding-bottom: 80px; }
        h1, h2, h3, h4, h5, h6 { font-family: 'Poppins', sans-serif; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 50; }
        .nav-item { transition: all 0.2s; }
        .nav-item.active { color: #FF4458; }
        .nav-item svg { width: 24px; height: 24px; }
    </style>
</head>
<body class="bg-[#FFEAA7]">
    <div id="setupArea" class="px-4 pt-6">
        <h2 class="text-2xl font-bold text-[#2D3436] mb-2">Configuration</h2>
        <p class="text-[#2D3436] opacity-75 mb-6">Créez votre établissement</p>
        
        <div class="bg-white rounded-2xl p-6">
            <form onsubmit="createEstablishment(event)">
                <div class="mb-4">
                    <label class="block text-[#2D3436] mb-2 text-sm font-semibold">Nom du lieu</label>
                    <input type="text" id="estName" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:border-[#FF4458]">
                </div>
                <div class="mb-4">
                    <label class="block text-[#2D3436] mb-2 text-sm font-semibold">Description</label>
                    <textarea id="estDescription" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:border-[#FF4458]"></textarea>
                </div>
                <div class="mb-6">
                    <label class="block text-[#2D3436] mb-2 text-sm font-semibold">Adresse</label>
                    <input type="text" id="estAddress" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:border-[#FF4458]">
                </div>
                <button type="submit" class="w-full py-3 bg-[#FF4458] text-white rounded-full hover:bg-[#e03d4c] transition font-semibold">
                    Créer l'établissement
                </button>
            </form>
        </div>
    </div>

    <div id="dashboardArea" class="hidden">
        <div id="page-dashboard" class="page-content">
            <div class="px-4 pt-4">
                <h1 class="text-2xl font-bold text-[#2D3436] mb-1">Dashboard</h1>
                <p class="text-sm text-[#2D3436] opacity-75 mb-4">Vos événements</p>
            </div>

            <div class="px-4 mb-4">
                <div class="flex space-x-2 overflow-x-auto pb-2">
                    <button onclick="filterRooms('all')" id="filter-all" class="px-4 py-2 rounded-full bg-[#FF4458] text-white font-semibold text-sm whitespace-nowrap">
                        Tous
                    </button>
                    <button onclick="filterRooms('active')" id="filter-active" class="px-4 py-2 rounded-full bg-gray-200 text-[#2D3436] font-semibold text-sm whitespace-nowrap">
                        Actifs
                    </button>
                    <button onclick="filterRooms('expired')" id="filter-expired" class="px-4 py-2 rounded-full bg-gray-200 text-[#2D3436] font-semibold text-sm whitespace-nowrap">
                        Expirés
                    </button>
                </div>
            </div>

            <div id="roomsList" class="px-4 space-y-4">
                <p class="text-[#2D3436] opacity-75">Aucun événement créé.</p>
            </div>

            <div class="px-4 pt-6">
                <button onclick="showCreateRoom()" class="w-full py-4 bg-gradient-to-r from-[#00B894] to-[#00a183] text-white rounded-full hover:opacity-90 transition font-semibold shadow-lg">
                    + Créer un événement
                </button>
            </div>
        </div>

        <div id="page-analytics" class="page-content hidden">
            <div class="px-4 pt-4">
                <h1 class="text-2xl font-bold text-[#2D3436] mb-6">Analytics</h1>
            </div>

            <div class="px-4 space-y-3 mb-6">
                <div class="bg-gradient-to-br from-[#FF4458] to-[#e03d4c] rounded-2xl p-5 text-white">
                    <div class="text-sm opacity-90 mb-1">Rooms totales</div>
                    <div id="analytics-total" class="text-3xl font-bold">0</div>
                </div>
                <div class="bg-gradient-to-br from-[#6C5CE7] to-[#5a4dd9] rounded-2xl p-5 text-white">
                    <div class="text-sm opacity-90 mb-1">Rooms actives</div>
                    <div id="analytics-active" class="text-3xl font-bold">0</div>
                </div>
                <div class="bg-gradient-to-br from-[#00B894] to-[#00a183] rounded-2xl p-5 text-white">
                    <div class="text-sm opacity-90 mb-1">Membres totaux</div>
                    <div id="analytics-members" class="text-3xl font-bold">0</div>
                </div>
                <div class="bg-gradient-to-br from-[#A29BFE] to-[#9189f7] rounded-2xl p-5 text-white">
                    <div class="text-sm opacity-90 mb-1">Rooms aujourd'hui</div>
                    <div id="analytics-today" class="text-3xl font-bold">0/1</div>
                </div>
            </div>

            <div class="px-4">
                <div class="bg-white rounded-2xl p-5 mb-3">
                    <h3 class="font-bold text-[#2D3436] mb-3 text-sm">Détails abonnement</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-[#2D3436] opacity-75">Plan</span>
                            <span id="analytics-plan" class="font-semibold text-[#FF4458] capitalize">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-[#2D3436] opacity-75">Coût mensuel</span>
                            <span id="analytics-price" class="font-semibold text-[#2D3436]">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-[#2D3436] opacity-75">Limite quotidienne</span>
                            <span id="analytics-limit" class="font-semibold text-[#2D3436]">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="page-profile" class="page-content hidden">
            <div class="px-4 pt-4">
                <h1 class="text-2xl font-bold text-[#2D3436] mb-6">Profil établissement</h1>
            </div>

            <div class="px-4 space-y-4">
                <div class="bg-white rounded-2xl p-5">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="text-sm text-[#2D3436] opacity-75 mb-1">Nom du lieu</div>
                            <div id="profile-name" class="font-bold text-[#2D3436]">-</div>
                        </div>
                        <div>
                            <div class="text-sm text-[#2D3436] opacity-75 mb-1">Plan</div>
                            <div id="profile-plan" class="font-bold text-[#FF4458] capitalize">-</div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl p-5">
                    <div class="text-sm text-[#2D3436] opacity-75 mb-2">Description</div>
                    <div id="profile-description" class="text-[#2D3436]">-</div>
                </div>

                <div class="bg-white rounded-2xl p-5">
                    <div class="text-sm text-[#2D3436] opacity-75 mb-2">Adresse</div>
                    <div id="profile-address" class="text-[#2D3436]">-</div>
                </div>

                <div class="bg-white rounded-2xl p-5">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="text-sm text-[#2D3436] opacity-75 mb-1">Prix mensuel</div>
                            <div id="profile-price" class="font-bold text-[#00B894]">-</div>
                        </div>
                        <div>
                            <div class="text-sm text-[#2D3436] opacity-75 mb-1">Limite quotidienne</div>
                            <div id="profile-limit" class="font-bold text-[#6C5CE7]">-</div>
                        </div>
                    </div>
                </div>

                <button onclick="logout()" class="w-full py-3 bg-gray-200 text-[#2D3436] rounded-full hover:bg-gray-300 transition font-semibold">
                    Déconnexion
                </button>
            </div>
        </div>

        <div class="bottom-nav">
            <div class="grid grid-cols-3 h-16">
                <button onclick="switchPage('dashboard')" id="nav-dashboard" class="nav-item active flex flex-col items-center justify-center">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                    </svg>
                    <span class="text-xs mt-1">Dashboard</span>
                </button>
                <button onclick="switchPage('analytics')" id="nav-analytics" class="nav-item flex flex-col items-center justify-center">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    <span class="text-xs mt-1">Analytics</span>
                </button>
                <button onclick="switchPage('profile')" id="nav-profile" class="nav-item flex flex-col items-center justify-center">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                    </svg>
                    <span class="text-xs mt-1">Profil</span>
                </button>
            </div>
        </div>
    </div>

    <div id="createRoomModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-end z-50">
        <div class="bg-white rounded-t-3xl w-full p-6 max-h-[85vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-[#2D3436]">Nouvel événement</h3>
                <button onclick="closeCreateRoom()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <form onsubmit="createRoom(event)">
                <div class="mb-3">
                    <label class="block text-[#2D3436] mb-2 text-sm font-semibold">Nom de l'événement</label>
                    <input type="text" id="roomName" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:border-[#FF4458]">
                </div>
                <div class="mb-3">
                    <label class="block text-[#2D3436] mb-2 text-sm font-semibold">Description</label>
                    <textarea id="roomDescription" rows="2" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:border-[#FF4458]"></textarea>
                </div>
                <div class="mb-3">
                    <label class="block text-[#2D3436] mb-2 text-sm font-semibold">Message de bienvenue</label>
                    <textarea id="roomWelcome" rows="2" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:border-[#FF4458]"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                        <label class="block text-[#2D3436] mb-2 text-sm font-semibold">Date & heure</label>
                        <input type="datetime-local" id="roomDateTime" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:border-[#FF4458]">
                    </div>
                    <div>
                        <label class="block text-[#2D3436] mb-2 text-sm font-semibold">Capacité max</label>
                        <input type="number" id="roomCapacity" min="2" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:border-[#FF4458]">
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-3 mb-4">
                    <div>
                        <label class="block text-[#2D3436] mb-2 text-sm font-semibold">Genre</label>
                        <select id="roomGender" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:border-[#FF4458]">
                            <option value="">Tous</option>
                            <option value="male">Homme</option>
                            <option value="female">Femme</option>
                            <option value="non-binary">Non-binaire</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[#2D3436] mb-2 text-sm font-semibold">Âge min</label>
                        <input type="number" id="roomAgeMin" min="18" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:border-[#FF4458]">
                    </div>
                    <div>
                        <label class="block text-[#2D3436] mb-2 text-sm font-semibold">Âge max</label>
                        <input type="number" id="roomAgeMax" max="120" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:border-[#FF4458]">
                    </div>
                </div>
                <button type="submit" class="w-full py-3 bg-[#00B894] text-white rounded-full hover:bg-[#00a183] transition font-semibold">
                    Créer l'événement
                </button>
            </form>
        </div>
    </div>

    <script>
        let establishmentId = null;
        let establishmentData = null;
        let currentPage = 'dashboard';
        let currentFilter = 'all';

        function checkAuth() {
            const token = localStorage.getItem('token');
            const userData = localStorage.getItem('user');
            if (!token || !userData) {
                window.location.href = '/';
                return;
            }
            const user = JSON.parse(userData);
            if (user.role !== 'establishment' && user.role !== 'admin') {
                window.location.href = '/app.html';
            }
        }

        async function loadEstablishment() {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch('/api/establishments/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.id) {
                        establishmentId = data.id;
                        establishmentData = data;
                        document.getElementById('setupArea').classList.add('hidden');
                        document.getElementById('dashboardArea').classList.remove('hidden');
                        updateProfile();
                        loadAnalytics();
                        loadRooms();
                    }
                }
            } catch (error) {
                console.error('Error loading establishment:', error);
            }
        }

        function updateProfile() {
            if (!establishmentData) return;
            
            document.getElementById('profile-name').textContent = establishmentData.name;
            document.getElementById('profile-description').textContent = establishmentData.description || 'Aucune description';
            document.getElementById('profile-address').textContent = establishmentData.address || 'Aucune adresse';
            document.getElementById('profile-plan').textContent = establishmentData.subscription_plan;
            document.getElementById('profile-price').textContent = `$${establishmentData.subscription_price}/mois`;
            
            const maxRooms = { 'one-shot': 1, 'silver': 1, 'gold': 3 }[establishmentData.subscription_plan] || 1;
            document.getElementById('profile-limit').textContent = `${maxRooms} rooms/jour`;
        }

        async function loadAnalytics() {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch('/api/establishments/me/analytics', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    document.getElementById('analytics-total').textContent = data.total_rooms;
                    document.getElementById('analytics-active').textContent = data.active_rooms;
                    document.getElementById('analytics-members').textContent = data.total_members;
                    document.getElementById('analytics-today').textContent = `${data.rooms_today}/${data.max_rooms_today}`;
                    
                    document.getElementById('analytics-plan').textContent = establishmentData.subscription_plan;
                    document.getElementById('analytics-price').textContent = `$${establishmentData.subscription_price}/mois`;
                    document.getElementById('analytics-limit').textContent = `${data.max_rooms_today} rooms/jour`;
                }
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        async function loadRooms() {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch(`/api/establishments/me/rooms?status=${currentFilter}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const rooms = await response.json();
                    displayRooms(rooms);
                }
            } catch (error) {
                console.error('Error loading rooms:', error);
            }
        }

        function displayRooms(rooms) {
            const list = document.getElementById('roomsList');
            
            if (rooms.length === 0) {
                list.innerHTML = '<p class="text-[#2D3436] opacity-75">Aucun événement trouvé.</p>';
                return;
            }
            
            list.innerHTML = rooms.map(room => `
                <div class="bg-white rounded-2xl p-4 ${room.is_active ? 'border-l-4 border-[#00B894]' : 'opacity-75'}">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-bold text-[#2D3436]">${room.name}</h4>
                        <span class="px-2 py-1 rounded-full text-xs font-semibold ${room.is_active ? 'bg-[#00B894] text-white' : 'bg-gray-300 text-[#2D3436]'}">
                            ${room.is_active ? 'Actif' : 'Expiré'}
                        </span>
                    </div>
                    <p class="text-sm text-[#2D3436] opacity-75 mb-2">${room.description || 'Pas de description'}</p>
                    <div class="flex items-center gap-4 text-xs text-[#2D3436] opacity-75">
                        <span>👥 ${room.member_count}${room.max_capacity ? '/' + room.max_capacity : ''}</span>
                        <span>📅 ${new Date(room.created_at).toLocaleDateString()}</span>
                    </div>
                </div>
            `).join('');
        }

        function switchPage(page) {
            currentPage = page;
            
            document.querySelectorAll('.page-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`page-${page}`).classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${page}`).classList.add('active');
        }

        function filterRooms(status) {
            currentFilter = status;
            
            document.querySelectorAll('[id^="filter-"]').forEach(el => {
                el.classList.remove('bg-[#FF4458]', 'text-white');
                el.classList.add('bg-gray-200', 'text-[#2D3436]');
            });
            document.getElementById(`filter-${status}`).classList.remove('bg-gray-200', 'text-[#2D3436]');
            document.getElementById(`filter-${status}`).classList.add('bg-[#FF4458]', 'text-white');
            
            loadRooms();
        }

        function showCreateRoom() {
            document.getElementById('createRoomModal').classList.remove('hidden');
        }

        function closeCreateRoom() {
            document.getElementById('createRoomModal').classList.add('hidden');
        }

        async function createEstablishment(e) {
            e.preventDefault();
            const token = localStorage.getItem('token');
            
            const data = {
                name: document.getElementById('estName').value,
                description: document.getElementById('estDescription').value,
                address: document.getElementById('estAddress').value
            };
            
            try {
                const response = await fetch('/api/establishments', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    establishmentId = result.id;
                    await loadEstablishment();
                    alert('Établissement créé avec succès !');
                } else {
                    alert('Erreur lors de la création');
                }
            } catch (error) {
                alert('Erreur de connexion');
            }
        }

        async function createRoom(e) {
            e.preventDefault();
            if (!establishmentId) return;
            
            const token = localStorage.getItem('token');
            
            const data = {
                name: document.getElementById('roomName').value,
                description: document.getElementById('roomDescription').value,
                welcome_message: document.getElementById('roomWelcome').value,
                event_datetime: document.getElementById('roomDateTime').value || null,
                max_capacity: document.getElementById('roomCapacity').value || null,
                access_gender: document.getElementById('roomGender').value || null,
                access_age_min: document.getElementById('roomAgeMin').value || null,
                access_age_max: document.getElementById('roomAgeMax').value || null
            };
            
            try {
                const response = await fetch(`/api/establishments/${establishmentId}/rooms`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    alert('Événement créé avec succès !');
                    e.target.reset();
                    closeCreateRoom();
                    loadAnalytics();
                    loadRooms();
                } else {
                    const error = await response.json();
                    alert(error.message || 'Erreur lors de la création');
                }
            } catch (error) {
                alert('Erreur de connexion');
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/';
        }

        checkAuth();
        loadEstablishment();
    </script>
</body>
</html>
