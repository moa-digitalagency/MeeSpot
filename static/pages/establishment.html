<!DOCTYPE html>
<!--
MatchSpot
MOA Digital Agency LLC
Par : Aisance KALONJI
Mail : moa@myoneart.com
www.myoneart.com
-->

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MatchSpot - Establishment Dashboard</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#FF4081">
    <script src="/css/tailwind.js"></script>
    <link href="/css/fonts.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; padding-bottom: 80px; max-width: 768px; margin: 0 auto; }
        h1, h2, h3, h4, h5, h6 { font-family: 'Poppins', sans-serif; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; max-width: 768px; margin: 0 auto; background: white; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 50; }
        .nav-item { transition: all 0.2s; }
        .nav-item.active { color: #FF4081; }
        .nav-item svg { width: 24px; height: 24px; }
    </style>
</head>
<body class="bg-[#F5F5F5]">
    <div id="setupArea" class="px-4 pt-6">
        <h2 class="text-2xl font-bold text-[#2D3436] mb-2">Configuration</h2>
        <p class="text-[#2D3436] opacity-75 mb-6">Cr√©ez votre √©tablissement</p>
        
        <div class="bg-white rounded-2xl p-6">
            <form onsubmit="createEstablishment(event)">
                <div class="mb-4">
                    <label class="block text-[#2D3436] mb-2 text-sm font-semibold">Nom du lieu</label>
                    <input type="text" id="estName" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:border-[#FF4081]">
                </div>
                <div class="mb-4">
                    <label class="block text-[#2D3436] mb-2 text-sm font-semibold">Description</label>
                    <textarea id="estDescription" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:border-[#FF4081]"></textarea>
                </div>
                <div class="mb-6">
                    <label class="block text-[#2D3436] mb-2 text-sm font-semibold">Adresse</label>
                    <input type="text" id="estAddress" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:border-[#FF4081]">
                </div>
                <button type="submit" class="w-full py-3 bg-[#FF4081] text-white rounded-full hover:bg-[#e0377a] transition font-semibold">
                    Cr√©er l'√©tablissement
                </button>
            </form>
        </div>
    </div>

    <div id="dashboardArea" class="hidden">
        <div id="page-dashboard" class="page-content">
            <div class="px-4 pt-4">
                <h1 class="text-2xl font-bold text-[#2D3436] mb-1">Dashboard</h1>
                <p class="text-sm text-[#2D3436] opacity-75 mb-4">Vos rooms</p>
            </div>

            <div class="px-4 mb-4">
                <div class="flex space-x-2 overflow-x-auto pb-2">
                    <button onclick="filterRooms('all')" id="filter-all" class="px-4 py-2 rounded-full bg-[#FF4081] text-white font-semibold text-sm whitespace-nowrap">
                        Tous
                    </button>
                    <button onclick="filterRooms('active')" id="filter-active" class="px-4 py-2 rounded-full bg-gray-200 text-[#2D3436] font-semibold text-sm whitespace-nowrap">
                        Actifs
                    </button>
                    <button onclick="filterRooms('expired')" id="filter-expired" class="px-4 py-2 rounded-full bg-gray-200 text-[#2D3436] font-semibold text-sm whitespace-nowrap">
                        Expir√©s
                    </button>
                </div>
            </div>

            <div id="roomsList" class="px-4 space-y-4">
                <p class="text-[#2D3436] opacity-75">Aucune room cr√©√©e.</p>
            </div>

            <div class="px-4 pt-6">
                <button onclick="showCreateRoom()" class="w-full py-4 bg-gradient-to-r from-[#00B894] to-[#00a183] text-white rounded-full hover:opacity-90 transition font-semibold shadow-lg">
                    + Cr√©er une room
                </button>
            </div>
        </div>

        <div id="page-analytics" class="page-content hidden">
            <div class="px-4 pt-4">
                <h1 class="text-2xl font-bold text-[#2D3436] mb-6">Analytics</h1>
            </div>

            <div class="px-4 space-y-3 mb-6">
                <div class="bg-gradient-to-br from-[#FF4081] to-[#e0377a] rounded-2xl p-5 text-white">
                    <div class="text-sm opacity-90 mb-1">Rooms totales</div>
                    <div id="analytics-total" class="text-3xl font-bold">0</div>
                </div>
                <div class="bg-gradient-to-br from-[#5B4DFF] to-[#5a4dd9] rounded-2xl p-5 text-white">
                    <div class="text-sm opacity-90 mb-1">Rooms actives</div>
                    <div id="analytics-active" class="text-3xl font-bold">0</div>
                </div>
                <div class="bg-gradient-to-br from-[#00B894] to-[#00a183] rounded-2xl p-5 text-white">
                    <div class="text-sm opacity-90 mb-1">Membres totaux</div>
                    <div id="analytics-members" class="text-3xl font-bold">0</div>
                </div>
                <div class="bg-gradient-to-br from-[#A29BFE] to-[#9189f7] rounded-2xl p-5 text-white">
                    <div id="analytics-today-label" class="text-sm opacity-90 mb-1">Rooms aujourd'hui</div>
                    <div id="analytics-today" class="text-3xl font-bold">0/1</div>
                </div>
            </div>

            <div class="px-4">
                <div class="bg-white rounded-2xl p-5 mb-3">
                    <h3 class="font-bold text-[#2D3436] mb-3 text-sm">D√©tails abonnement</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-[#2D3436] opacity-75">Plan</span>
                            <span id="analytics-plan" class="font-semibold text-[#FF4081] capitalize">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-[#2D3436] opacity-75">Co√ªt mensuel</span>
                            <span id="analytics-price" class="font-semibold text-[#2D3436]">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span id="analytics-limit-label" class="text-[#2D3436] opacity-75">Limite quotidienne</span>
                            <span id="analytics-limit" class="font-semibold text-[#2D3436]">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="page-profile" class="page-content hidden">
            <div class="px-4 pt-4">
                <h1 class="text-2xl font-bold text-[#2D3436] mb-6">Profil √©tablissement</h1>
            </div>

            <div class="px-4 space-y-4">
                <div class="bg-white rounded-2xl p-5">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="text-sm text-[#2D3436] opacity-75 mb-1">Nom du lieu</div>
                            <div id="profile-name" class="font-bold text-[#2D3436]">-</div>
                        </div>
                        <div>
                            <div class="text-sm text-[#2D3436] opacity-75 mb-1">Plan</div>
                            <div id="profile-plan" class="font-bold text-[#FF4081] capitalize">-</div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl p-5">
                    <div class="text-sm text-[#2D3436] opacity-75 mb-2">Description</div>
                    <div id="profile-description" class="text-[#2D3436]">-</div>
                </div>

                <div class="bg-white rounded-2xl p-5">
                    <div class="text-sm text-[#2D3436] opacity-75 mb-2">Adresse</div>
                    <div id="profile-address" class="text-[#2D3436]">-</div>
                </div>

                <div class="bg-white rounded-2xl p-5">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="text-sm text-[#2D3436] opacity-75 mb-1">Prix mensuel</div>
                            <div id="profile-price" class="font-bold text-[#00B894]">-</div>
                        </div>
                        <div>
                            <div id="profile-limit-label" class="text-sm text-[#2D3436] opacity-75 mb-1">Limite quotidienne</div>
                            <div id="profile-limit" class="font-bold text-[#5B4DFF]">-</div>
                        </div>
                    </div>
                </div>

                <div class="bg-gradient-to-br from-[#00B894] to-[#00a183] rounded-2xl p-5 text-white">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <h4 class="text-lg font-bold">One-Shot</h4>
                            <p class="text-sm opacity-90">Achat unique - Cr√©ez 1 room valable 24h</p>
                        </div>
                        <div class="text-right ml-2">
                            <div class="text-2xl font-bold">$19</div>
                            <div class="text-xs opacity-75">unique</div>
                        </div>
                    </div>
                    <div class="text-sm opacity-90 mb-3">
                        üéØ Cr√©ez une room instantan√©ment sans abonnement
                    </div>
                    <button onclick="buyOneShot()" class="w-full bg-white text-[#00B894] rounded-full py-2 px-4 text-sm font-semibold hover:bg-opacity-90 transition">
                        Acheter One-Shot
                    </button>
                </div>

                <button onclick="showProfileSettings()" class="w-full py-3 bg-gradient-to-r from-[#FF4081] to-[#5B4DFF] text-white rounded-full hover:opacity-90 transition font-semibold">
                    ‚öôÔ∏è Param√®tres du profil
                </button>

                <button onclick="showChangePlanModal()" class="w-full py-3 bg-[#5B4DFF] text-white rounded-full hover:bg-[#5b4ed6] transition font-semibold">
                    üíé Changer de forfait
                </button>

                <button onclick="logout()" class="w-full py-3 bg-gray-200 text-[#2D3436] rounded-full hover:bg-gray-300 transition font-semibold">
                    D√©connexion
                </button>
            </div>
        </div>

        <div class="bottom-nav">
            <div class="grid grid-cols-3 h-16">
                <button onclick="switchPage('dashboard')" id="nav-dashboard" class="nav-item active flex flex-col items-center justify-center">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                    </svg>
                    <span class="text-xs mt-1">Dashboard</span>
                </button>
                <button onclick="switchPage('analytics')" id="nav-analytics" class="nav-item flex flex-col items-center justify-center">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    <span class="text-xs mt-1">Analytics</span>
                </button>
                <button onclick="switchPage('profile')" id="nav-profile" class="nav-item flex flex-col items-center justify-center">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                    </svg>
                    <span class="text-xs mt-1">Profil</span>
                </button>
            </div>
        </div>
    </div>

    <div id="roomDetailsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-end z-50">
        <div class="bg-white rounded-t-3xl w-full p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-[#2D3436]">D√©tails de la room</h3>
                <button onclick="closeRoomDetails()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <div class="space-y-4">
                <div class="bg-gradient-to-br from-[#FF4081] to-[#e0377a] rounded-2xl p-6 text-white text-center">
                    <div class="text-sm opacity-90 mb-2">Code d'acc√®s</div>
                    <div id="detailsAccessCode" class="text-4xl font-bold font-mono tracking-widest mb-4">--------</div>
                    <div class="bg-white p-4 rounded-xl flex justify-center items-center" id="qrCodeContainer">
                        <canvas id="qrCode"></canvas>
                    </div>
                    <button onclick="downloadQRCode()" class="mt-4 px-6 py-3 bg-white text-[#FF4081] rounded-full font-semibold hover:bg-opacity-90 flex items-center justify-center mx-auto">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                        </svg>
                        T√©l√©charger QR Code
                    </button>
                    <p class="text-xs mt-3 opacity-90">Scannez le QR code ou utilisez le code ci-dessus</p>
                </div>

                <div class="bg-white rounded-2xl border-2 border-gray-200 p-4">
                    <div class="flex items-center justify-between mb-2">
                        <h4 id="detailsRoomName" class="font-bold text-[#2D3436] text-lg">-</h4>
                        <button onclick="editRoomName()" class="text-[#FF4081] text-sm font-semibold hover:underline">Modifier</button>
                    </div>
                    <p id="detailsRoomDescription" class="text-sm text-[#2D3436] opacity-75 mb-3">-</p>
                    
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div class="bg-[#F5F5F5] rounded-xl p-3">
                            <div class="text-[#2D3436] opacity-75 text-xs mb-1">Participants</div>
                            <div id="detailsMemberCount" class="font-bold text-[#2D3436] text-xl">0</div>
                        </div>
                        <div class="bg-[#A29BFE] rounded-xl p-3 text-white">
                            <div class="opacity-90 text-xs mb-1">Capacit√© max</div>
                            <div id="detailsMaxCapacity" class="font-bold text-xl">-</div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl border-2 border-gray-200 p-4">
                    <h4 class="font-bold text-[#2D3436] mb-3">Liste des participants</h4>
                    <div id="membersList" class="space-y-2 max-h-40 overflow-y-auto">
                        <p class="text-sm text-[#2D3436] opacity-75">Chargement...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="createRoomModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-end z-50">
        <div class="bg-white rounded-t-3xl w-full p-6 max-h-[85vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-[#2D3436]">Nouvelle room</h3>
                <button onclick="closeCreateRoom()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <form onsubmit="createRoom(event)">
                <div class="mb-3">
                    <label class="block text-[#2D3436] mb-2 text-sm font-semibold">Nom de la room</label>
                    <input type="text" id="roomName" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:border-[#FF4081]">
                </div>
                <div class="mb-3">
                    <label class="block text-[#2D3436] mb-2 text-sm font-semibold">Description</label>
                    <textarea id="roomDescription" rows="2" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:border-[#FF4081]"></textarea>
                </div>
                <div class="mb-3">
                    <label class="block text-[#2D3436] mb-2 text-sm font-semibold">Message de bienvenue</label>
                    <textarea id="roomWelcome" rows="2" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:border-[#FF4081]"></textarea>
                </div>
                <div class="mb-3">
                    <label class="block text-[#2D3436] mb-2 text-sm font-semibold">Capacit√© max</label>
                    <input type="number" id="roomCapacity" min="2" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:border-[#FF4081]">
                </div>
                
                <div class="mb-3">
                    <h4 class="font-bold text-[#2D3436] mb-2">Filtres d'acc√®s (optionnel)</h4>
                    <p class="text-xs text-[#2D3436] opacity-75 mb-3">S√©lectionnez les crit√®res pour filtrer les participants</p>
                </div>
                
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                        <label class="block text-[#2D3436] mb-2 text-sm font-semibold">Genre</label>
                        <select id="roomGender" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:border-[#FF4081]">
                            <option value="">Tous</option>
                            <option value="male">Homme</option>
                            <option value="female">Femme</option>
                            <option value="non-binary">Non-binaire</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[#2D3436] mb-2 text-sm font-semibold">Orientation</label>
                        <select id="roomOrientation" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:border-[#FF4081]">
                            <option value="">Toutes</option>
                            <option value="heterosexual">H√©t√©rosexuel(le)</option>
                            <option value="homosexual">Homosexuel(le)</option>
                            <option value="bisexual">Bisexuel(le)</option>
                            <option value="pansexual">Pansexuel(le)</option>
                            <option value="asexual">Asexuel(le)</option>
                            <option value="other">Autre</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                        <label class="block text-[#2D3436] mb-2 text-sm font-semibold">√Çge min</label>
                        <input type="number" id="roomAgeMin" min="18" placeholder="18+" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:border-[#FF4081]">
                    </div>
                    <div>
                        <label class="block text-[#2D3436] mb-2 text-sm font-semibold">√Çge max</label>
                        <input type="number" id="roomAgeMax" max="120" placeholder="Pas de limite" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:border-[#FF4081]">
                    </div>
                </div>
                <div class="mb-3">
                    <label class="block text-[#2D3436] mb-2 text-sm font-semibold">Type de rencontre</label>
                    <select id="roomMeetingType" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:border-[#FF4081]">
                        <option value="">Tous</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="block text-[#2D3436] mb-2 text-sm font-semibold">Religion</label>
                    <select id="roomReligion" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:border-[#FF4081]">
                        <option value="">Toutes</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-[#2D3436] mb-2 text-sm font-semibold">LGBT+ Friendly</label>
                    <select id="roomLGBTQ" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:border-[#FF4081]">
                        <option value="">Pas de pr√©f√©rence</option>
                        <option value="yes">Oui</option>
                        <option value="no">Non</option>
                        <option value="prefer_not_to_say">Pr√©f√®re ne pas dire</option>
                    </select>
                </div>
                <button type="submit" class="w-full py-3 bg-[#00B894] text-white rounded-full hover:bg-[#00a183] transition font-semibold">
                    Cr√©er la room
                </button>
            </form>
        </div>
    </div>

    <div id="changePlanModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-3xl w-full max-w-md p-6 mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-[#2D3436]">Changer de forfait</h3>
                <button onclick="closeChangePlanModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <div id="availablePlans" class="space-y-3 mb-4">
                <p class="text-sm text-[#2D3436] opacity-75">Chargement...</p>
            </div>

            <p class="text-xs text-[#2D3436] opacity-75 text-center">
                La demande sera envoy√©e √† l'administrateur pour approbation
            </p>
        </div>
    </div>

    <div id="profileSettingsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-end z-50">
        <div class="bg-white rounded-t-3xl w-full p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-[#2D3436]">‚öôÔ∏è Param√®tres du profil</h3>
                <button onclick="closeProfileSettings()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <form onsubmit="saveProfileSettings(event)">
                <div class="mb-4">
                    <label class="block text-[#2D3436] mb-2 text-sm font-semibold">Nom de l'√©tablissement</label>
                    <input type="text" id="settingsName" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:border-[#FF4081]">
                </div>
                <div class="mb-4">
                    <label class="block text-[#2D3436] mb-2 text-sm font-semibold">Description</label>
                    <textarea id="settingsDescription" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:border-[#FF4081]"></textarea>
                </div>
                <div class="mb-4">
                    <label class="block text-[#2D3436] mb-2 text-sm font-semibold">Photo par d√©faut (pour les rooms)</label>
                    <input type="file" id="settingsPhoto" accept="image/*" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:border-[#FF4081]">
                    <p class="text-xs text-[#2D3436] opacity-75 mt-1">Cette photo sera utilis√©e par d√©faut pour toutes vos rooms</p>
                </div>
                <div id="currentPhoto" class="mb-4 hidden">
                    <img id="currentPhotoPreview" src="" alt="Photo actuelle" class="w-32 h-32 object-cover rounded-xl">
                </div>
                <button type="submit" class="w-full py-3 bg-[#FF4081] text-white rounded-full hover:bg-[#e0377a] transition font-semibold">
                    Enregistrer les modifications
                </button>
            </form>
        </div>
    </div>

    <script>
        let establishmentId = null;
        let establishmentData = null;
        let currentPage = 'dashboard';
        let currentFilter = 'all';
        let availablePlans = [];

        function checkAuth() {
            const token = localStorage.getItem('token');
            const userData = localStorage.getItem('user');
            if (!token || !userData) {
                window.location.href = '/';
                return;
            }
            const user = JSON.parse(userData);
            if (user.role !== 'establishment' && user.role !== 'admin') {
                window.location.href = '/app.html';
            }
        }

        async function loadEstablishment() {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch('/api/establishments/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.id) {
                        establishmentId = data.id;
                        establishmentData = data;
                        document.getElementById('setupArea').classList.add('hidden');
                        document.getElementById('dashboardArea').classList.remove('hidden');
                        updateProfileDisplay();
                        loadAnalytics();
                        loadRooms();
                        loadProfileOptions();
                    }
                }
            } catch (error) {
                console.error('Error loading establishment:', error);
            }
        }

        async function loadProfileOptions() {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch('/api/profile-options', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const options = await response.json();
                    
                    const meetingTypeSelect = document.getElementById('roomMeetingType');
                    meetingTypeSelect.innerHTML = '<option value="">Tous</option>';
                    if (options.meeting_type && options.meeting_type.length > 0) {
                        options.meeting_type.forEach(opt => {
                            if (opt.is_active) {
                                const option = document.createElement('option');
                                option.value = opt.value;
                                option.textContent = `${opt.emoji || ''} ${opt.label}`;
                                meetingTypeSelect.appendChild(option);
                            }
                        });
                    }
                    
                    const religionSelect = document.getElementById('roomReligion');
                    religionSelect.innerHTML = '<option value="">Toutes</option>';
                    if (options.religion && options.religion.length > 0) {
                        options.religion.forEach(opt => {
                            if (opt.is_active) {
                                const option = document.createElement('option');
                                option.value = opt.value;
                                option.textContent = opt.label;
                                religionSelect.appendChild(option);
                            }
                        });
                    }
                    
                    const genderSelect = document.getElementById('roomGender');
                    genderSelect.innerHTML = '<option value="">Tous</option>';
                    if (options.gender && options.gender.length > 0) {
                        options.gender.forEach(opt => {
                            if (opt.is_active) {
                                const option = document.createElement('option');
                                option.value = opt.value;
                                option.textContent = opt.label;
                                genderSelect.appendChild(option);
                            }
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading profile options:', error);
            }
        }

        function updateProfileDisplay() {
            if (!establishmentData) return;
            
            document.getElementById('profile-name').textContent = establishmentData.name;
            document.getElementById('profile-description').textContent = establishmentData.description || 'Aucune description';
            document.getElementById('profile-address').textContent = establishmentData.address || 'Aucune adresse';
            document.getElementById('profile-plan').textContent = establishmentData.subscription_plan || 'Pas de forfait actif';
            document.getElementById('profile-price').textContent = establishmentData.subscription_plan ? `$${establishmentData.subscription_price}/mois` : '-';
            
            if (establishmentData.subscription_plan === 'silver') {
                document.getElementById('profile-limit-label').textContent = 'Limite hebdomadaire';
                document.getElementById('profile-limit').textContent = '3 rooms/semaine';
            } else if (establishmentData.subscription_plan === 'gold') {
                document.getElementById('profile-limit-label').textContent = 'Limite hebdomadaire';
                document.getElementById('profile-limit').textContent = '7 rooms/semaine';
            } else {
                document.getElementById('profile-limit-label').textContent = 'Limite quotidienne';
                const maxRooms = { 'one-shot': 1 }[establishmentData.subscription_plan] || 1;
                document.getElementById('profile-limit').textContent = `${maxRooms} rooms/jour`;
            }
        }

        async function loadAnalytics() {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch('/api/establishments/me/analytics', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    document.getElementById('analytics-total').textContent = data.total_rooms;
                    document.getElementById('analytics-active').textContent = data.active_rooms;
                    document.getElementById('analytics-members').textContent = data.total_members;
                    
                    if (data.plan_type === 'weekly') {
                        document.getElementById('analytics-today-label').textContent = 'Rooms cette semaine';
                        document.getElementById('analytics-today').textContent = `${data.rooms_this_week}/${data.max_rooms_per_week}`;
                        document.getElementById('analytics-limit-label').textContent = 'Limite hebdomadaire';
                        document.getElementById('analytics-limit').textContent = `${data.max_rooms_per_week} rooms/semaine`;
                    } else {
                        document.getElementById('analytics-today-label').textContent = 'Rooms aujourd\'hui';
                        document.getElementById('analytics-today').textContent = `${data.rooms_today}/${data.max_rooms_today}`;
                        document.getElementById('analytics-limit-label').textContent = 'Limite quotidienne';
                        document.getElementById('analytics-limit').textContent = `${data.max_rooms_today} rooms/jour`;
                    }
                    
                    document.getElementById('analytics-plan').textContent = establishmentData.subscription_plan || 'Pas de forfait actif';
                    document.getElementById('analytics-price').textContent = establishmentData.subscription_plan ? `$${establishmentData.subscription_price}/mois` : '-';
                }
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        async function loadRooms() {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch(`/api/establishments/me/rooms?status=${currentFilter}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const rooms = await response.json();
                    displayRooms(rooms);
                }
            } catch (error) {
                console.error('Error loading rooms:', error);
            }
        }

        function displayRooms(rooms) {
            const list = document.getElementById('roomsList');
            
            if (rooms.length === 0) {
                list.innerHTML = '<p class="text-[#2D3436] opacity-75">Aucune room trouv√©e.</p>';
                return;
            }
            
            list.innerHTML = rooms.map(room => `
                <div class="bg-white rounded-2xl p-4 ${room.is_active ? 'border-l-4 border-[#00B894]' : 'opacity-75'}" onclick="showRoomDetails(${room.id})">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-bold text-[#2D3436]">${room.name}</h4>
                        <span class="px-2 py-1 rounded-full text-xs font-semibold ${room.is_active ? 'bg-[#00B894] text-white' : 'bg-gray-300 text-[#2D3436]'}">
                            ${room.is_active ? 'Actif' : 'Expir√©'}
                        </span>
                    </div>
                    <p class="text-sm text-[#2D3436] opacity-75 mb-2">${room.description || 'Pas de description'}</p>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4 text-xs text-[#2D3436] opacity-75">
                            <span>üë• ${room.member_count}${room.max_capacity ? '/' + room.max_capacity : ''}</span>
                            <span>üìÖ ${new Date(room.created_at).toLocaleDateString()}</span>
                        </div>
                        <span class="text-xs font-mono bg-[#FF4081] text-white px-2 py-1 rounded">üîë ${room.access_code}</span>
                    </div>
                </div>
            `).join('');
        }

        function switchPage(page) {
            currentPage = page;
            
            document.querySelectorAll('.page-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`page-${page}`).classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${page}`).classList.add('active');
        }

        function filterRooms(status) {
            currentFilter = status;
            
            document.querySelectorAll('[id^="filter-"]').forEach(el => {
                el.classList.remove('bg-[#FF4081]', 'text-white');
                el.classList.add('bg-gray-200', 'text-[#2D3436]');
            });
            document.getElementById(`filter-${status}`).classList.remove('bg-gray-200', 'text-[#2D3436]');
            document.getElementById(`filter-${status}`).classList.add('bg-[#FF4081]', 'text-white');
            
            loadRooms();
        }

        function showCreateRoom() {
            document.getElementById('createRoomModal').classList.remove('hidden');
        }

        function closeCreateRoom() {
            document.getElementById('createRoomModal').classList.add('hidden');
        }

        async function showRoomDetails(roomId) {
            const token = localStorage.getItem('token');
            
            currentEditingRoomId = roomId;
            document.getElementById('roomDetailsModal').classList.remove('hidden');
            
            try {
                const response = await fetch(`/api/establishments/me/rooms/${roomId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const room = await response.json();
                    
                    document.getElementById('detailsAccessCode').textContent = room.access_code;
                    document.getElementById('detailsRoomName').textContent = room.name;
                    document.getElementById('detailsRoomDescription').textContent = room.description || 'Pas de description';
                    document.getElementById('detailsMemberCount').textContent = room.member_count;
                    document.getElementById('detailsMaxCapacity').textContent = room.max_capacity || '‚àû';
                    
                    const qrCode = new QRious({
                        element: document.getElementById('qrCode'),
                        value: room.access_code,
                        size: 200,
                        level: 'H'
                    });
                    
                    const membersList = document.getElementById('membersList');
                    if (room.members && room.members.length > 0) {
                        const genderCounts = room.members.reduce((acc, m) => {
                            acc[m.gender] = (acc[m.gender] || 0) + 1;
                            return acc;
                        }, {});
                        
                        membersList.innerHTML = `
                            <div class="space-y-3">
                                <div class="flex items-center justify-between py-2 px-3 bg-[#F5F5F5] rounded-lg">
                                    <span class="font-semibold text-[#2D3436]">üë• Total</span>
                                    <span class="text-xl font-bold text-[#FF4081]">${room.members.length}</span>
                                </div>
                                ${Object.entries(genderCounts).map(([gender, count]) => `
                                    <div class="flex items-center justify-between py-2 px-3 border-b">
                                        <span class="text-[#2D3436]">${gender === 'male' ? 'üë® Hommes' : gender === 'female' ? 'üë© Femmes' : 'üßë Autres'}</span>
                                        <span class="font-bold text-[#5B4DFF]">${count}</span>
                                    </div>
                                `).join('')}
                                <p class="text-xs text-[#2D3436] opacity-50 mt-2 italic">üîí Les noms des participants sont priv√©s pour prot√©ger leur confidentialit√©</p>
                            </div>
                        `;
                    } else {
                        membersList.innerHTML = '<p class="text-sm text-[#2D3436] opacity-75">Aucun participant pour le moment</p>';
                    }
                }
            } catch (error) {
                console.error('Error loading room details:', error);
            }
        }

        function closeRoomDetails() {
            document.getElementById('roomDetailsModal').classList.add('hidden');
        }

        let currentEditingRoomId = null;

        function downloadQRCode() {
            const canvas = document.getElementById('qrCode');
            const accessCode = document.getElementById('detailsAccessCode').textContent;
            const roomName = document.getElementById('detailsRoomName').textContent;
            
            const tempCanvas = document.createElement('canvas');
            const ctx = tempCanvas.getContext('2d');
            
            tempCanvas.width = 1600;
            tempCanvas.height = 2000;
            
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            
            ctx.font = 'bold 96px Inter, sans-serif';
            ctx.fillStyle = '#2D3436';
            ctx.textAlign = 'center';
            ctx.fillText(roomName, 800, 160);
            
            ctx.font = '64px Inter, sans-serif';
            ctx.fillStyle = '#666';
            ctx.fillText('Room MatchSpot', 800, 280);
            
            const qrX = (tempCanvas.width - 800) / 2;
            ctx.drawImage(canvas, qrX, 400, 800, 800);
            
            ctx.font = 'bold 128px monospace';
            ctx.fillStyle = '#FF4081';
            ctx.fillText(accessCode, 800, 1400);
            
            ctx.strokeStyle = '#CCCCCC';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(200, 1500);
            ctx.lineTo(1400, 1500);
            ctx.stroke();
            
            ctx.font = '56px Inter, sans-serif';
            ctx.fillStyle = '#666';
            ctx.fillText('Scannez le QR code ou utilisez le code ci-dessus', 800, 1600);
            ctx.fillText('pour rejoindre cette room', 800, 1680);
            
            ctx.font = 'bold 64px Inter, sans-serif';
            ctx.fillStyle = '#FF4081';
            ctx.fillText('www.thematchspot.com', 800, 1820);
            
            tempCanvas.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `QRCode-${accessCode}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
        }

        function editRoomName() {
            const nameElement = document.getElementById('detailsRoomName');
            const currentName = nameElement.textContent;
            const newName = prompt('Nouveau nom de la room:', currentName);
            
            if (newName && newName.trim() !== '' && newName !== currentName) {
                updateRoomName(currentEditingRoomId, newName.trim());
            }
        }

        async function updateRoomName(roomId, newName) {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch(`/api/establishments/rooms/${roomId}/update-name`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name: newName })
                });
                
                if (response.ok) {
                    document.getElementById('detailsRoomName').textContent = newName;
                    alert('‚úÖ Nom modifi√© avec succ√®s !');
                    loadRooms();
                } else {
                    const error = await response.json();
                    alert('Erreur: ' + (error.message || 'Impossible de modifier le nom'));
                }
            } catch (error) {
                console.error('Error updating room name:', error);
                alert('Erreur de connexion');
            }
        }

        async function createEstablishment(e) {
            e.preventDefault();
            const token = localStorage.getItem('token');
            
            const data = {
                name: document.getElementById('estName').value,
                description: document.getElementById('estDescription').value,
                address: document.getElementById('estAddress').value
            };
            
            try {
                const response = await fetch('/api/establishments', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    establishmentId = result.id;
                    await loadEstablishment();
                    alert('√âtablissement cr√©√© avec succ√®s !');
                } else {
                    alert('Erreur lors de la cr√©ation');
                }
            } catch (error) {
                alert('Erreur de connexion');
            }
        }

        async function createRoom(e) {
            e.preventDefault();
            if (!establishmentId) return;
            
            const token = localStorage.getItem('token');
            
            const data = {
                name: document.getElementById('roomName').value,
                description: document.getElementById('roomDescription').value,
                welcome_message: document.getElementById('roomWelcome').value,
                max_capacity: document.getElementById('roomCapacity').value || null,
                access_gender: document.getElementById('roomGender').value || null,
                access_orientation: document.getElementById('roomOrientation').value || null,
                access_age_min: document.getElementById('roomAgeMin').value || null,
                access_age_max: document.getElementById('roomAgeMax').value || null,
                access_meeting_type: document.getElementById('roomMeetingType').value || null,
                access_religion: document.getElementById('roomReligion').value || null,
                access_lgbtq_friendly: document.getElementById('roomLGBTQ').value || null
            };
            
            try {
                const response = await fetch(`/api/establishments/${establishmentId}/rooms`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    alert('Room cr√©√©e avec succ√®s !');
                    e.target.reset();
                    closeCreateRoom();
                    loadAnalytics();
                    loadRooms();
                } else {
                    const error = await response.json();
                    if (error.no_plan) {
                        if (confirm(error.message + '\n\nVoulez-vous acheter un forfait maintenant?')) {
                            closeCreateRoom();
                            showChangePlanModal();
                        }
                    } else if (error.limit_reached && error.can_buy_oneshot) {
                        if (confirm(error.message + '\n\nVoulez-vous acheter un One-Shot ($19)?')) {
                            closeCreateRoom();
                            buyOneShot();
                        }
                    } else {
                        alert(error.message || 'Erreur lors de la cr√©ation');
                    }
                }
            } catch (error) {
                alert('Erreur de connexion');
            }
        }

        async function showChangePlanModal() {
            const token = localStorage.getItem('token');
            document.getElementById('changePlanModal').classList.remove('hidden');
            
            try {
                const response = await fetch('/api/subscriptions/plans', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const plans = await response.json();
                    availablePlans = plans.filter(p => p.role === 'establishment' && p.is_active);
                    displayAvailablePlans();
                }
            } catch (error) {
                console.error('Error loading plans:', error);
                document.getElementById('availablePlans').innerHTML = '<p class="text-red-500 text-sm">Erreur lors du chargement des forfaits</p>';
            }
        }

        function displayAvailablePlans() {
            const container = document.getElementById('availablePlans');
            const currentPlan = establishmentData.subscription_plan;
            
            // Filter out 'one-shot' from subscription plans (it's now a one-time purchase in profile)
            const subscriptionPlans = availablePlans.filter(p => p.name !== 'one-shot');
            
            if (subscriptionPlans.length === 0) {
                container.innerHTML = '<p class="text-sm text-[#2D3436] opacity-75">Aucun forfait disponible</p>';
                return;
            }
            
            container.innerHTML = subscriptionPlans.map(plan => `
                <div class="bg-gradient-to-br from-[#5B4DFF] to-[#A29BFE] rounded-2xl p-4 text-white ${currentPlan === plan.name ? 'ring-4 ring-[#00B894]' : ''}">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            <h4 class="text-lg font-bold">${plan.name}</h4>
                            <p class="text-sm opacity-90">${plan.description}</p>
                        </div>
                        <div class="text-right ml-2">
                            <div class="text-2xl font-bold">${plan.price}‚Ç¨</div>
                            <div class="text-xs opacity-75">/mois</div>
                        </div>
                    </div>
                    <div class="text-sm opacity-90 mb-3">
                        üìç ${plan.rooms_per_day} ${plan.rooms_per_day > 1 ? 'rooms' : 'room'} par jour
                    </div>
                    ${currentPlan === plan.name 
                        ? '<div class="bg-white/20 rounded-full py-2 px-4 text-center text-sm font-semibold">‚úì Forfait actuel</div>'
                        : `<button onclick="requestPlanChange('${plan.name}')" class="w-full bg-white text-[#5B4DFF] rounded-full py-2 px-4 text-sm font-semibold hover:bg-opacity-90 transition">Demander ce forfait</button>`
                    }
                </div>
            `).join('');
        }

        function closeChangePlanModal() {
            document.getElementById('changePlanModal').classList.add('hidden');
        }

        async function requestPlanChange(planName) {
            if (!confirm(`Voulez-vous demander le forfait "${planName}" ?`)) return;
            
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch('/api/subscriptions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ subscription_tier: planName })
                });
                
                if (response.ok) {
                    alert('‚úì Demande de changement de forfait envoy√©e ! L\'administrateur l\'examinera bient√¥t.');
                    closeChangePlanModal();
                } else {
                    const error = await response.json();
                    alert(error.message || 'Erreur lors de l\'envoi de la demande');
                }
            } catch (error) {
                alert('Erreur de connexion');
            }
        }

        function showProfileSettings() {
            if (!establishmentData) return;
            document.getElementById('settingsName').value = establishmentData.name;
            document.getElementById('settingsDescription').value = establishmentData.description || '';
            
            if (establishmentData.photo_url) {
                document.getElementById('currentPhoto').classList.remove('hidden');
                document.getElementById('currentPhotoPreview').src = establishmentData.photo_url;
            }
            
            document.getElementById('profileSettingsModal').classList.remove('hidden');
        }

        function closeProfileSettings() {
            document.getElementById('profileSettingsModal').classList.add('hidden');
        }

        async function saveProfileSettings(e) {
            e.preventDefault();
            const token = localStorage.getItem('token');
            const data = {
                name: document.getElementById('settingsName').value,
                description: document.getElementById('settingsDescription').value
            };
            
            const photoInput = document.getElementById('settingsPhoto');
            if (photoInput.files && photoInput.files[0]) {
                const file = photoInput.files[0];
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    try {
                        const uploadResponse = await fetch('/api/upload/image', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                image: e.target.result,
                                type: 'profile'
                            })
                        });
                        
                        if (uploadResponse.ok) {
                            const uploadData = await uploadResponse.json();
                            data.photo_url = uploadData.url;
                        }
                        
                        await updateProfile(data, token);
                    } catch (error) {
                        alert('Erreur lors du t√©l√©chargement de la photo');
                    }
                };
                
                reader.readAsDataURL(file);
            } else {
                await updateProfile(data, token);
            }
        }

        async function updateProfile(data, token) {
            try {
                const response = await fetch('/api/establishments/me/profile', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    establishmentData = result.establishment;
                    updateProfileDisplay();
                    closeProfileSettings();
                    alert('‚úì Profil mis √† jour avec succ√®s!');
                } else {
                    const error = await response.json();
                    alert(error.message || 'Erreur lors de la mise √† jour');
                }
            } catch (error) {
                alert('Erreur de connexion');
            }
        }

        async function buyOneShot() {
            if (!confirm('Acheter un One-Shot pour $19?\n\nCe forfait vous permet de cr√©er 1 room valable 24h.')) return;
            
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch('/api/establishments/me/buy-plan', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ plan_name: 'one-shot' })
                });
                
                if (response.ok) {
                    alert('‚úì One-Shot achet√© avec succ√®s! Vous pouvez maintenant cr√©er votre room.');
                    loadEstablishment();
                    loadAnalytics();
                } else {
                    const error = await response.json();
                    alert(error.message || 'Erreur lors de l\'achat');
                }
            } catch (error) {
                alert('Erreur de connexion');
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/';
        }

        checkAuth();
        loadEstablishment();
    </script>
</body>
</html>
