<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MeetSpot - Establishment Dashboard</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#FF4458">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        h1, h2, h3, h4, h5, h6 { font-family: 'Poppins', sans-serif; }
        .tab-active { border-bottom: 3px solid #FF4458; color: #FF4458; }
    </style>
</head>
<body class="bg-[#FFEAA7]">
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-[#FF4458]">MeetSpot Dashboard</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="logout()" class="px-4 py-2 text-[#2D3436] hover:text-[#FF4458] transition">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="mb-8">
            <h2 class="text-3xl font-bold text-[#2D3436] mb-2">Establishment Dashboard</h2>
            <p class="text-[#2D3436] opacity-75">Manage your venue and events</p>
        </div>

        <div id="setupArea" class="bg-white rounded-2xl p-8 mb-8">
            <h3 class="text-2xl font-bold text-[#2D3436] mb-6">Setup Your Establishment</h3>
            <form onsubmit="createEstablishment(event)">
                <div class="mb-4">
                    <label class="block text-[#2D3436] mb-2">Venue Name</label>
                    <input type="text" id="estName" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-[#FF4458]">
                </div>
                <div class="mb-4">
                    <label class="block text-[#2D3436] mb-2">Description</label>
                    <textarea id="estDescription" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-[#FF4458]"></textarea>
                </div>
                <div class="mb-6">
                    <label class="block text-[#2D3436] mb-2">Address</label>
                    <input type="text" id="estAddress" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-[#FF4458]">
                </div>
                <button type="submit" class="px-8 py-3 bg-[#FF4458] text-white rounded-full hover:bg-[#e03d4c] transition font-semibold">Create Establishment</button>
            </form>
        </div>

        <div id="dashboardArea" class="hidden">
            <div class="bg-white rounded-t-2xl border-b border-gray-200">
                <div class="flex space-x-8 px-8">
                    <button onclick="switchTab('profile')" id="tab-profile" class="py-4 font-semibold text-[#2D3436] hover:text-[#FF4458] transition tab-active">Profile</button>
                    <button onclick="switchTab('analytics')" id="tab-analytics" class="py-4 font-semibold text-[#2D3436] hover:text-[#FF4458] transition">Analytics</button>
                    <button onclick="switchTab('dashboard')" id="tab-dashboard" class="py-4 font-semibold text-[#2D3436] hover:text-[#FF4458] transition">Dashboard</button>
                </div>
            </div>

            <div id="content-profile" class="tab-content bg-white rounded-b-2xl p-8 mb-8">
                <h3 class="text-2xl font-bold text-[#2D3436] mb-6">Establishment Profile</h3>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-[#2D3436] opacity-75 mb-2">Venue Name</label>
                        <p id="profile-name" class="text-lg font-semibold text-[#2D3436]">-</p>
                    </div>
                    <div>
                        <label class="block text-[#2D3436] opacity-75 mb-2">Subscription Plan</label>
                        <p id="profile-plan" class="text-lg font-semibold text-[#FF4458] capitalize">-</p>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-[#2D3436] opacity-75 mb-2">Description</label>
                        <p id="profile-description" class="text-[#2D3436]">-</p>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-[#2D3436] opacity-75 mb-2">Address</label>
                        <p id="profile-address" class="text-[#2D3436]">-</p>
                    </div>
                    <div>
                        <label class="block text-[#2D3436] opacity-75 mb-2">Monthly Price</label>
                        <p id="profile-price" class="text-lg font-semibold text-[#00B894]">-</p>
                    </div>
                    <div>
                        <label class="block text-[#2D3436] opacity-75 mb-2">Daily Room Limit</label>
                        <p id="profile-limit" class="text-lg font-semibold text-[#6C5CE7]">-</p>
                    </div>
                </div>
            </div>

            <div id="content-analytics" class="tab-content hidden bg-white rounded-b-2xl p-8 mb-8">
                <h3 class="text-2xl font-bold text-[#2D3436] mb-6">Analytics</h3>
                <div class="grid md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-gradient-to-br from-[#FF4458] to-[#e03d4c] rounded-xl p-6 text-white">
                        <h4 class="text-sm opacity-90 mb-2">Total Rooms Created</h4>
                        <p id="analytics-total" class="text-4xl font-bold">0</p>
                    </div>
                    <div class="bg-gradient-to-br from-[#6C5CE7] to-[#5a4dd9] rounded-xl p-6 text-white">
                        <h4 class="text-sm opacity-90 mb-2">Active Rooms</h4>
                        <p id="analytics-active" class="text-4xl font-bold">0</p>
                    </div>
                    <div class="bg-gradient-to-br from-[#00B894] to-[#00a183] rounded-xl p-6 text-white">
                        <h4 class="text-sm opacity-90 mb-2">Total Members</h4>
                        <p id="analytics-members" class="text-4xl font-bold">0</p>
                    </div>
                    <div class="bg-gradient-to-br from-[#A29BFE] to-[#9189f7] rounded-xl p-6 text-white">
                        <h4 class="text-sm opacity-90 mb-2">Rooms Today</h4>
                        <p id="analytics-today" class="text-4xl font-bold">0/1</p>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <div class="border border-gray-200 rounded-xl p-6">
                        <h4 class="font-semibold text-[#2D3436] mb-4">Subscription Details</h4>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-[#2D3436] opacity-75">Plan</span>
                                <span id="analytics-plan" class="font-semibold text-[#FF4458] capitalize">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-[#2D3436] opacity-75">Monthly Cost</span>
                                <span id="analytics-price" class="font-semibold text-[#2D3436]">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-[#2D3436] opacity-75">Daily Limit</span>
                                <span id="analytics-limit" class="font-semibold text-[#2D3436]">-</span>
                            </div>
                        </div>
                    </div>
                    <div class="border border-gray-200 rounded-xl p-6">
                        <h4 class="font-semibold text-[#2D3436] mb-4">Quick Stats</h4>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-[#2D3436] opacity-75">Avg Members/Room</span>
                                <span id="analytics-avg" class="font-semibold text-[#2D3436]">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-[#2D3436] opacity-75">Room Utilization</span>
                                <span id="analytics-util" class="font-semibold text-[#2D3436]">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="content-dashboard" class="tab-content hidden">
                <div class="bg-white rounded-b-2xl p-8 mb-8">
                    <h3 class="text-2xl font-bold text-[#2D3436] mb-6">Create New Event</h3>
                    <form onsubmit="createRoom(event)">
                        <div class="grid md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-[#2D3436] mb-2">Event Name</label>
                                <input type="text" id="roomName" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-[#FF4458]">
                            </div>
                            <div>
                                <label class="block text-[#2D3436] mb-2">Max Capacity</label>
                                <input type="number" id="roomCapacity" min="2" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-[#FF4458]">
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-[#2D3436] mb-2">Description</label>
                            <textarea id="roomDescription" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-[#FF4458]"></textarea>
                        </div>
                        <div class="mb-4">
                            <label class="block text-[#2D3436] mb-2">Welcome Message</label>
                            <textarea id="roomWelcome" rows="2" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-[#FF4458]"></textarea>
                        </div>
                        <div class="mb-4">
                            <label class="block text-[#2D3436] mb-2">Event Date & Time</label>
                            <input type="datetime-local" id="roomDateTime" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-[#FF4458]">
                        </div>
                        <div class="grid md:grid-cols-3 gap-4 mb-6">
                            <div>
                                <label class="block text-[#2D3436] mb-2">Gender Filter</label>
                                <select id="roomGender" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-[#FF4458]">
                                    <option value="">Any</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                    <option value="non-binary">Non-binary</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-[#2D3436] mb-2">Min Age</label>
                                <input type="number" id="roomAgeMin" min="18" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-[#FF4458]">
                            </div>
                            <div>
                                <label class="block text-[#2D3436] mb-2">Max Age</label>
                                <input type="number" id="roomAgeMax" max="120" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-[#FF4458]">
                            </div>
                        </div>
                        <button type="submit" class="px-8 py-3 bg-[#00B894] text-white rounded-full hover:bg-[#00a183] transition font-semibold">Create Event</button>
                    </form>
                </div>

                <div class="bg-white rounded-2xl p-8">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-[#2D3436]">Your Events</h3>
                        <div class="flex space-x-2">
                            <button onclick="filterRooms('all')" id="filter-all" class="px-4 py-2 rounded-lg bg-[#FF4458] text-white font-semibold">All</button>
                            <button onclick="filterRooms('active')" id="filter-active" class="px-4 py-2 rounded-lg bg-gray-200 text-[#2D3436] hover:bg-gray-300">Active</button>
                            <button onclick="filterRooms('expired')" id="filter-expired" class="px-4 py-2 rounded-lg bg-gray-200 text-[#2D3436] hover:bg-gray-300">Expired</button>
                        </div>
                    </div>
                    <div id="roomsList" class="space-y-4">
                        <p class="text-[#2D3436] opacity-75">No events created yet.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let establishmentId = null;
        let establishmentData = null;
        let currentTab = 'profile';
        let currentFilter = 'all';

        function checkAuth() {
            const token = localStorage.getItem('token');
            const userData = localStorage.getItem('user');
            if (!token || !userData) {
                window.location.href = '/';
                return;
            }
            const user = JSON.parse(userData);
            if (user.role !== 'establishment' && user.role !== 'admin') {
                window.location.href = '/app.html';
            }
        }

        async function loadEstablishment() {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch('/api/establishments/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.id) {
                        establishmentId = data.id;
                        establishmentData = data;
                        document.getElementById('setupArea').classList.add('hidden');
                        document.getElementById('dashboardArea').classList.remove('hidden');
                        updateProfile();
                        loadAnalytics();
                        loadRooms();
                    }
                }
            } catch (error) {
                console.error('Error loading establishment:', error);
            }
        }

        function updateProfile() {
            if (!establishmentData) return;
            
            document.getElementById('profile-name').textContent = establishmentData.name;
            document.getElementById('profile-description').textContent = establishmentData.description || 'No description';
            document.getElementById('profile-address').textContent = establishmentData.address || 'No address';
            document.getElementById('profile-plan').textContent = establishmentData.subscription_plan;
            document.getElementById('profile-price').textContent = `$${establishmentData.subscription_price}/month`;
            
            const maxRooms = { 'one-shot': 1, 'silver': 1, 'gold': 3 }[establishmentData.subscription_plan] || 1;
            document.getElementById('profile-limit').textContent = `${maxRooms} rooms/day`;
        }

        async function loadAnalytics() {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch('/api/establishments/me/analytics', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    document.getElementById('analytics-total').textContent = data.total_rooms;
                    document.getElementById('analytics-active').textContent = data.active_rooms;
                    document.getElementById('analytics-members').textContent = data.total_members;
                    document.getElementById('analytics-today').textContent = `${data.rooms_today}/${data.max_rooms_today}`;
                    
                    document.getElementById('analytics-plan').textContent = establishmentData.subscription_plan;
                    document.getElementById('analytics-price').textContent = `$${establishmentData.subscription_price}/month`;
                    document.getElementById('analytics-limit').textContent = `${data.max_rooms_today} rooms/day`;
                    
                    const avgMembers = data.total_rooms > 0 ? Math.round(data.total_members / data.total_rooms) : 0;
                    document.getElementById('analytics-avg').textContent = avgMembers;
                    
                    const utilization = data.max_rooms_today > 0 ? Math.round((data.rooms_today / data.max_rooms_today) * 100) : 0;
                    document.getElementById('analytics-util').textContent = `${utilization}%`;
                }
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        async function loadRooms() {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch(`/api/establishments/me/rooms?status=${currentFilter}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const rooms = await response.json();
                    displayRooms(rooms);
                }
            } catch (error) {
                console.error('Error loading rooms:', error);
            }
        }

        function displayRooms(rooms) {
            const list = document.getElementById('roomsList');
            
            if (rooms.length === 0) {
                list.innerHTML = '<p class="text-[#2D3436] opacity-75">No events found.</p>';
                return;
            }
            
            list.innerHTML = rooms.map(room => `
                <div class="border border-gray-200 rounded-xl p-6 ${room.is_active ? 'bg-green-50' : 'bg-gray-50'}">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h4 class="text-xl font-bold text-[#2D3436] mb-1">${room.name}</h4>
                            <p class="text-[#2D3436] opacity-75">${room.description || 'No description'}</p>
                        </div>
                        <span class="px-3 py-1 rounded-full text-sm font-semibold ${room.is_active ? 'bg-[#00B894] text-white' : 'bg-gray-300 text-[#2D3436]'}">
                            ${room.is_active ? 'Active' : 'Expired'}
                        </span>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                        <div>
                            <span class="text-[#2D3436] opacity-75">Members:</span>
                            <span class="font-semibold ml-1">${room.member_count}${room.max_capacity ? '/' + room.max_capacity : ''}</span>
                        </div>
                        <div>
                            <span class="text-[#2D3436] opacity-75">Gender:</span>
                            <span class="font-semibold ml-1 capitalize">${room.access_gender || 'Any'}</span>
                        </div>
                        <div>
                            <span class="text-[#2D3436] opacity-75">Age:</span>
                            <span class="font-semibold ml-1">${room.access_age_min || 18}-${room.access_age_max || 99}</span>
                        </div>
                        <div>
                            <span class="text-[#2D3436] opacity-75">Created:</span>
                            <span class="font-semibold ml-1">${new Date(room.created_at).toLocaleDateString()}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function switchTab(tab) {
            currentTab = tab;
            
            document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.remove('tab-active'));
            document.getElementById(`tab-${tab}`).classList.add('tab-active');
            
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`content-${tab}`).classList.remove('hidden');
        }

        function filterRooms(status) {
            currentFilter = status;
            
            document.querySelectorAll('[id^="filter-"]').forEach(el => {
                el.classList.remove('bg-[#FF4458]', 'text-white');
                el.classList.add('bg-gray-200', 'text-[#2D3436]');
            });
            document.getElementById(`filter-${status}`).classList.remove('bg-gray-200', 'text-[#2D3436]');
            document.getElementById(`filter-${status}`).classList.add('bg-[#FF4458]', 'text-white');
            
            loadRooms();
        }

        async function createEstablishment(e) {
            e.preventDefault();
            const token = localStorage.getItem('token');
            
            const data = {
                name: document.getElementById('estName').value,
                description: document.getElementById('estDescription').value,
                address: document.getElementById('estAddress').value
            };
            
            try {
                const response = await fetch('/api/establishments', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    establishmentId = result.id;
                    await loadEstablishment();
                    alert('Establishment created successfully!');
                } else {
                    alert('Error creating establishment');
                }
            } catch (error) {
                alert('Connection error');
            }
        }

        async function createRoom(e) {
            e.preventDefault();
            if (!establishmentId) return;
            
            const token = localStorage.getItem('token');
            
            const data = {
                name: document.getElementById('roomName').value,
                description: document.getElementById('roomDescription').value,
                welcome_message: document.getElementById('roomWelcome').value,
                event_datetime: document.getElementById('roomDateTime').value || null,
                max_capacity: document.getElementById('roomCapacity').value || null,
                access_gender: document.getElementById('roomGender').value || null,
                access_age_min: document.getElementById('roomAgeMin').value || null,
                access_age_max: document.getElementById('roomAgeMax').value || null
            };
            
            try {
                const response = await fetch(`/api/establishments/${establishmentId}/rooms`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    alert('Event created successfully!');
                    e.target.reset();
                    loadAnalytics();
                    loadRooms();
                } else {
                    const error = await response.json();
                    alert(error.message || 'Error creating event');
                }
            } catch (error) {
                alert('Connection error');
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/';
        }

        checkAuth();
        loadEstablishment();
    </script>
</body>
</html>
